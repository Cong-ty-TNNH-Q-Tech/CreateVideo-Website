name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get diff
        id: diff
        run: |
          diff=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install @anthropic-ai/sdk

      - name: AI Review
        uses: actions/github-script@v7
        with:
          script: |
            const { Anthropic } = require(process.cwd() + '/node_modules/@anthropic-ai/sdk');
            const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

            // Create prompt
            const diff = `
            ${{ steps.diff.outputs.diff }}
            `.substr(0, 150000); // Truncate to avoid token limits if necessary

            const changedFiles = `${{ steps.changed.outputs.files }}`;

            const systemPrompt = `You are a senior code reviewer. Review the provided code diff.
            Focus on:
            1. Bugs and potential runtime errors
            2. Security vulnerabilities
            3. Performance improvements
            4. Code style and best practices
            
            Provide the review in Markdown format.`;

            try {
              const response = await client.messages.create({
                model: "claude-3-sonnet-20240229",
                max_tokens: 4096,
                messages: [{
                  role: "user",
                  content: `Review this PR diff and provide feedback:\n\nChanged files: ${changedFiles}\n\nDiff:\n${diff}`
                }],
                system: systemPrompt
              });

              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: response.content[0].text,
                event: 'COMMENT'
              });
            } catch (error) {
              console.error('Error in AI review:', error);
              // Don't fail the build, just log error
            }
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
