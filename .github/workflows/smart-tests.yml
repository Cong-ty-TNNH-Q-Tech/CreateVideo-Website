name: Smart Test Selection

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      test_suites: ${{ steps.analyze.outputs.suites }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze changes
        id: analyze
        run: |
          # Get changed files
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$changed"

          # Determine which test suites to run
          suites="[]"

          # Presentation logic changes
          if echo "$changed" | grep -qE "utils/presentation_reader.py|data/presentations.json"; then
            suites=$(echo $suites | jq '. + ["presentation"]')
          fi

          # API/Web logic changes
          if echo "$changed" | grep -qE "app.py|templates/|static/|tests/test_api_routes.py"; then
            suites=$(echo $suites | jq '. + ["api"]')
          fi
          
          # Core logic changes (might affect everything)
          if echo "$changed" | grep -qE "requirements.txt|run_tests.py|tests/test_integration.py"; then
             suites='["all"]'
          fi

          # If nothing matched specific patterns, run all to be safe
          if [ "$suites" = "[]" ]; then
            suites='["all"]'
          elif [ "$suites" != '["all"]' ]; then
            # Deduplicate if not all
            suites=$(echo $suites | jq 'unique')
          fi

          echo "Selected suites: $suites"
          echo "suites=$suites" >> $GITHUB_OUTPUT

  test:
    needs: analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(needs.analyze.outputs.test_suites) }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests
        run: |
          echo "Running suite: ${{ matrix.suite }}"
          
          if [ "${{ matrix.suite }}" = "all" ]; then
            python run_tests.py
          elif [ "${{ matrix.suite }}" = "presentation" ]; then
            python -m unittest tests/test_presentation_reader.py
          elif [ "${{ matrix.suite }}" = "api" ]; then
            python -m unittest tests/test_api_routes.py
          else
            echo "Unknown suite '${{ matrix.suite }}', running all..."
            python run_tests.py
          fi
