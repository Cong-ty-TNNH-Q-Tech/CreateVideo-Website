<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Video Thuy·∫øt Tr√¨nh - Step 1: Upload Presentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1000px;
        }

        .step-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            background: white;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .upload-area {
            border: 2px dashed #0d6efd;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #e7f1ff;
            border-color: #0a58ca;
        }

        .upload-area.dragover {
            background: #cfe2ff;
            border-color: #0a58ca;
        }

        .slides-preview {
            margin-top: 2rem;
        }

        .slide-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }

        .slide-header {
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 0.5rem;
        }

        .slide-content {
            color: #6c757d;
            font-size: 0.9rem;
            max-height: 100px;
            overflow-y: auto;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <div class="container py-5">
        <header class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary">T·∫°o Video Thuy·∫øt Tr√¨nh</h1>
            <p class="lead">T·ª± ƒë·ªông t·∫°o video thuy·∫øt tr√¨nh v·ªõi avatar n√≥i chuy·ªán</p>

            <!-- Navigation Links -->
            <div class="mt-3">
                <a href="/test/sadtalker" class="btn btn-outline-primary btn-sm me-2">üé¨ Test SadTalker</a>
                <a href="/test/tts" class="btn btn-outline-primary btn-sm">üé§ Test TTS</a>
            </div>
        </header>

        <!-- Step 1: Upload Presentation -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">1</div>
                <h3 class="mb-0">Upload File Presentation</h3>
            </div>

            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".pptx,.ppt,.pdf" style="display: none;">
                <div>
                    <svg width="64" height="64" fill="currentColor" class="text-primary mb-3" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5h2.767l12-12H.5a.5.5 0 0 1-.5.5v11.5z" />
                        <path
                            d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.74.439L8 13.069l-5.26 2.87A.5.5 0 0 1 2 15.5V2z" />
                    </svg>
                    <h4>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h4>
                    <p class="text-muted">H·ªó tr·ª£: .pptx, .ppt, .pdf</p>
                    <p class="text-muted">K√≠ch th∆∞·ªõc t·ªëi ƒëa: 100MB</p>
                </div>
            </div>

            <div id="fileInfo" style="display: none;" class="mt-3">
                <div class="alert alert-info">
                    <strong>File ƒë√£ ch·ªçn:</strong> <span id="fileName"></span>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearFile()">X√≥a</button>
                </div>
            </div>

            <div class="text-center mt-3">
                <button id="uploadBtn" class="btn btn-primary btn-lg" disabled onclick="uploadPresentation()">
                    üì§ Upload v√† ƒê·ªçc File
                </button>
            </div>
        </div>

        <!-- Slides Preview -->
        <div id="slidesPreview" class="step-card" style="display: none;">
            <div class="step-header">
                <div class="step-number">‚úì</div>
                <h3 class="mb-0">N·ªôi dung ƒë√£ ƒë·ªçc ƒë∆∞·ª£c</h3>
            </div>

            <div id="slidesList" class="slides-preview"></div>

            <div class="text-center mt-4">
                <button class="btn btn-success btn-lg" onclick="goToStep2()">
                    Ti·∫øp t·ª•c ‚Üí B∆∞·ªõc 2: Generate Text
                </button>
            </div>
        </div>

        <!-- Step 2: Generate & Edit Text -->
        <div id="step2Section" class="step-card" style="display: none;">
            <div class="step-header">
                <div class="step-number">2</div>
                <h3 class="mb-0">Generate & Edit Text Thuy·∫øt Tr√¨nh</h3>
            </div>

            <div class="alert alert-info">
                <strong>üí° H∆∞·ªõng d·∫´n:</strong>
                <ul class="mb-0">
                    <li>Click "Generate Text" ƒë·ªÉ t·∫°o text thuy·∫øt tr√¨nh t·ª± ƒë·ªông t·ª´ n·ªôi dung slide</li>
                    <li>B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a text sau khi generate</li>
                    <li>Click "Save" ƒë·ªÉ l∆∞u text ƒë√£ ch·ªânh s·ª≠a</li>
                    <li>Click "Generate Audio" ƒë·ªÉ t·∫°o file audio t·ª´ k·ªãch b·∫£n thuy·∫øt tr√¨nh</li>
                </ul>
            </div>

            <div id="slidesTextContainer"></div>

            <div class="text-center mt-4">
                <button class="btn btn-warning btn-lg me-2" onclick="saveAllScripts()">
                    üíæ Save All Scripts
                </button>
                <button class="btn btn-success btn-lg me-2" onclick="openVoiceSettings()">
                    üéµ Generate Audio
                </button>
                <button class="btn btn-primary btn-lg" onclick="goToStep4()" id="nextStepBtn" style="display:none;">
                    Ti·∫øp t·ª•c ‚Üí B∆∞·ªõc 4: Upload Avatar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h3 class="mt-3">ƒêang x·ª≠ l√Ω...</h3>
            <p class="text-muted" id="loadingText">Vui l√≤ng ƒë·ª£i</p>
        </div>
    </div>

    <!-- Voice Settings Modal -->
    <div class="modal fade" id="voiceSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üé§ Voice Settings & Generation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Voice Type Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Voice Type:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voiceType" id="voiceTypePreset"
                                value="preset" checked>
                            <label class="form-check-label" for="voiceTypePreset">
                                üë§ Preset Voice (VieNeu-TTS)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voiceType" id="voiceTypeClone"
                                value="clone">
                            <label class="form-check-label" for="voiceTypeClone">
                                üéôÔ∏è Clone Voice (Upload Audio)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voiceType" id="voiceTypeDefault"
                                value="default">
                            <label class="form-check-label" for="voiceTypeDefault">
                                üîä Default (gTTS or Auto)
                            </label>
                        </div>
                    </div>

                    <!-- Preset Voice Selection -->
                    <div class="mb-3" id="presetVoiceSection">
                        <label class="form-label fw-bold">Choose Preset Voice:</label>
                        <select class="form-select" id="presetVoiceSelect">
                            <option value="">Loading voices...</option>
                        </select>
                        <small class="text-muted">Vietnamese voices from VieNeu-TTS</small>
                    </div>

                    <!-- Clone Voice Upload -->
                    <div class="mb-3" id="cloneVoiceSection" style="display: none;">
                        <label class="form-label fw-bold">Upload Audio for Voice Cloning:</label>
                        <input type="file" class="form-control" id="cloneVoiceFile" accept="audio/*">
                        <small class="text-muted">Upload a clear audio sample (3-10 seconds recommended)</small>
                        <div id="cloneUploadStatus" class="mt-2"></div>
                    </div>

                    <hr>

                    <!-- Preview Section -->
                    <div class="mb-3 p-3 bg-light rounded">
                        <label class="form-label fw-bold mb-2">üîä Voice Preview:</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="previewText"
                                value="Xin ch√†o, ƒë√¢y l√† gi·ªçng n√≥i m·∫´u." placeholder="Text to preview...">
                            <button class="btn btn-outline-primary" type="button" onclick="previewVoice()">
                                ‚ñ∂Ô∏è Play Preview
                            </button>
                        </div>
                        <div id="previewAudioContainer" class="mt-2 text-center" style="display:none;">
                            <audio id="previewAudioPlayer" controls class="w-100"></audio>
                            <div id="previewStatus" class="small mt-1"></div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <strong>üí° Tip:</strong> For best results with voice cloning, use a clear audio recording
                        without background noise.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="applyAndGenerateAll()">
                        üöÄ OK - Generate Audio for All Slides
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPresentationId = null;
        let selectedFile = null;
        let voiceSettings = {}; // Store voice settings per slide: { slideNum: { type, voice_id, clone_path } }
        let currentModalSlide = null; // Track which slide is being configured
        let availableVoices = []; // Cache of available VieNeu voices

        // File input handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');

        // Click to select file
        uploadArea.addEventListener('click', () => fileInput.click());

        // File selected
        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileInfo.style.display = 'block';
                uploadBtn.disabled = false;
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.pptx') || file.name.endsWith('.ppt') || file.name.endsWith('.pdf'))) {
                selectedFile = file;
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = file.name;
                fileInfo.style.display = 'block';
                uploadBtn.disabled = false;
            } else {
                alert('Vui l√≤ng ch·ªçn file .pptx, .ppt ho·∫∑c .pdf');
            }
        });

        function clearFile() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadBtn.disabled = true;
        }

        async function uploadPresentation() {
            if (!selectedFile) {
                alert('Vui l√≤ng ch·ªçn file');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);

            showLoading('ƒêang upload v√† ƒë·ªçc file...');

            try {
                const response = await fetch('/api/upload-presentation', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentPresentationId = data.presentation_id;
                    displaySlides(data.slides);
                    hideLoading();
                } else {
                    hideLoading();
                    alert('L·ªói: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        function displaySlides(slides) {
            const slidesList = document.getElementById('slidesList');
            slidesList.innerHTML = '';

            slides.forEach(slide => {
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide-item';
                slideDiv.innerHTML = `
                <div class="slide-header">Slide ${slide.slide_num} / ${slide.total_slides}</div>
                <div class="slide-content">${slide.content || '(Kh√¥ng c√≥ n·ªôi dung)'}</div>
            `;
                slidesList.appendChild(slideDiv);
            });

            document.getElementById('slidesPreview').style.display = 'block';
        }

        function goToStep2() {
            if (currentPresentationId) {
                // L∆∞u presentation ID v√†o sessionStorage
                sessionStorage.setItem('presentationId', currentPresentationId);
                // Hi·ªÉn th·ªã Step 2
                document.getElementById('step2Section').style.display = 'block';
                document.getElementById('step2Section').scrollIntoView({ behavior: 'smooth' });
                // Load slides ƒë·ªÉ generate text
                loadSlidesForStep2();
            }
        }

        async function loadSlidesForStep2() {
            if (!currentPresentationId) return;

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/slides`);
                const data = await response.json();

                if (data.success) {
                    displaySlidesForStep2(data.slides);
                }
            } catch (error) {
                console.error('Error loading slides:', error);
            }
        }

        function displaySlidesForStep2(slides) {
            const slidesContainer = document.getElementById('slidesTextContainer');
            slidesContainer.innerHTML = '';

            slides.forEach(slide => {
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide-text-item mb-4';
                slideDiv.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Slide ${slide.slide_num} / ${slide.total_slides}</h5>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="generateText(${slide.slide_num})">
                                ‚ú® Generate Script
                            </button>
                            <button class="btn btn-sm btn-success ms-2" onclick="saveText(${slide.slide_num})" style="display:none;" id="saveBtn${slide.slide_num}">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <small class="text-muted">N·ªôi dung slide g·ªëc:</small>
                            <div class="bg-light p-2 rounded" style="max-height: 100px; overflow-y: auto;">
                                ${slide.content || '(Kh√¥ng c√≥ n·ªôi dung)'}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">K·ªãch b·∫£n thuy·∫øt tr√¨nh (Plain text suitable for TTS):</label>
                            <textarea 
                                class="form-control script-textarea" 
                                id="textArea${slide.slide_num}" 
                                data-slide-num="${slide.slide_num}"
                                rows="5" 
                                placeholder="Click 'Generate Script' ƒë·ªÉ t·∫°o k·ªãch b·∫£n thuy·∫øt tr√¨nh..."
                                oninput="markAsEdited(${slide.slide_num})"
                            >${slide.edited_text || slide.generated_text || ''}</textarea>
                        </div>
                        
                        <!-- Audio Section -->
                        <div class="mb-3" id="audioSection${slide.slide_num}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">üéµ Audio Result:</label>
                                <!-- Buttons removed as requested -->
                            </div>
                            
                            <div id="audioPlayer${slide.slide_num}" style="display: none;">
                                <audio controls class="w-100" id="audio${slide.slide_num}">
                                    <source src="" type="audio/wav">
                                    Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
                                </audio>
                            </div>
                            
                            <div id="audioStatus${slide.slide_num}" class="text-muted small mt-2">
                                ${slide.audio_url ? '<span class="text-success">‚úÖ Audio ƒë√£ t·∫°o</span>' : '<span class="text-info">‚ÑπÔ∏è Ch∆∞a t·∫°o audio cho slide n√†y</span>'}
                            </div>
                        </div>
                        
                        <div id="textStatus${slide.slide_num}" class="text-muted small"></div>
                    </div>
                </div>
            `;
                slidesContainer.appendChild(slideDiv);

                // Set up audio player if audio exists
                if (slide.audio_url) {
                    const audioPlayer = document.getElementById(`audioPlayer${slide.slide_num}`);
                    const audio = document.getElementById(`audio${slide.slide_num}`);
                    audio.src = slide.audio_url;
                    audioPlayer.style.display = 'block';
                }
            });
        }

        async function generateText(slideNum) {
            if (!currentPresentationId) return;

            const textArea = document.getElementById(`textArea${slideNum}`);
            const statusDiv = document.getElementById(`textStatus${slideNum}`);
            const saveBtn = document.getElementById(`saveBtn${slideNum}`);

            statusDiv.innerHTML = '<span class="text-info">‚è≥ ƒêang generate script...</span>';
            textArea.disabled = true;

            try {
                const response = await fetch('/api/generate-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        presentation_id: currentPresentationId,
                        slide_num: slideNum,
                        language: 'vi'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    textArea.value = data.text;
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ Script generated!</span>';
                    saveBtn.style.display = 'inline-block';
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Error generating script:', error);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
            } finally {
                textArea.disabled = false;
            }
        }

        function markAsEdited(slideNum) {
            const saveBtn = document.getElementById(`saveBtn${slideNum}`);
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
            }
        }

        async function saveText(slideNum) {
            if (!currentPresentationId) return;

            const textArea = document.getElementById(`textArea${slideNum}`);
            const statusDiv = document.getElementById(`textStatus${slideNum}`);
            const saveBtn = document.getElementById(`saveBtn${slideNum}`);

            statusDiv.innerHTML = '<span class="text-info">‚è≥ ƒêang l∆∞u...</span>';

            try {
                const response = await fetch('/api/save-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        presentation_id: currentPresentationId,
                        slide_num: slideNum,
                        edited_text: textArea.value
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ ƒê√£ l∆∞u!</span>';
                    saveBtn.style.display = 'none';
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Error saving text:', error);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
            }
        }

        async function saveAllScripts() {
            if (!currentPresentationId) return;

            const textAreas = document.querySelectorAll('.script-textarea');
            const slidesData = [];

            textAreas.forEach(area => {
                const slideNum = area.getAttribute('data-slide-num');
                const text = area.value;
                if (slideNum) {
                    slidesData.push({
                        slide_num: parseInt(slideNum),
                        text: text
                    });
                }
            });

            if (slidesData.length === 0) {
                alert("Kh√¥ng c√≥ script n√†o ƒë·ªÉ l∆∞u.");
                return;
            }

            showLoading('ƒêang l∆∞u t·∫•t c·∫£ scripts...');

            try {
                const response = await fetch('/api/save-all-texts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        presentation_id: currentPresentationId,
                        slides_data: slidesData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`ƒê√£ l∆∞u th√†nh c√¥ng ${data.saved_count} scripts!`);
                    // Hide individual save buttons
                    textAreas.forEach(area => {
                        const slideNum = area.getAttribute('data-slide-num');
                        const saveBtn = document.getElementById(`saveBtn${slideNum}`);
                        if (saveBtn) saveBtn.style.display = 'none';
                        const statusDiv = document.getElementById(`textStatus${slideNum}`);
                        if (statusDiv) statusDiv.innerHTML = '<span class="text-success">‚úÖ ƒê√£ l∆∞u!</span>';
                    });
                } else {
                    alert('L·ªói khi l∆∞u: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving all scripts:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showLoading(text = 'ƒêang x·ª≠ l√Ω...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function goToStep3() {
            if (currentPresentationId) {
                // First generate audio for all slides
                generateAllAudio();
            }
        }

        // ============== AUDIO FUNCTIONS ==============

        async function generateAllAudio() {
            if (!currentPresentationId) {
                alert('Kh√¥ng t√¨m th·∫•y presentation!');
                return;
            }

            showLoading('ƒêang t·∫°o audio cho t·∫•t c·∫£ slides...');

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/generate_audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Update UI for each slide
                    data.results.forEach(result => {
                        const slideNum = result.slide_index;
                        const audioStatus = document.getElementById(`audioStatus${slideNum}`);
                        const audioPlayer = document.getElementById(`audioPlayer${slideNum}`);
                        const audio = document.getElementById(`audio${slideNum}`);

                        // Check if elements exist before updating
                        if (!audioStatus) {
                            console.warn(`Audio elements not found for slide ${slideNum}`);
                            return;
                        }

                        if (result.success && result.audio_url) {
                            audioStatus.innerHTML = '<span class="text-success">‚úÖ Audio ƒë√£ t·∫°o</span>';
                            if (audio && audioPlayer) {
                                audio.src = result.audio_url;
                                audioPlayer.style.display = 'block';
                            }
                        } else {
                            audioStatus.innerHTML = `<span class="text-warning">‚ö†Ô∏è ${result.message}</span>`;
                        }
                    });

                    hideLoading();
                    alert(`ƒê√£ t·∫°o th√†nh c√¥ng audio cho ${data.success_count}/${data.total_slides} slides! B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c b∆∞·ªõc 4: Upload Avatar.`);

                    // Show next step button
                    showStep4Button();
                } else {
                    hideLoading();
                    alert('L·ªói khi t·∫°o audio: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error generating audio:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        async function regenerateAudio(slideNum) {
            if (!currentPresentationId) return;

            const audioStatus = document.getElementById(`audioStatus${slideNum}`);
            const regenBtn = document.getElementById(`regenAudioBtn${slideNum}`);

            if (!audioStatus || !regenBtn) {
                console.error(`Audio elements not found for slide ${slideNum}`);
                return;
            }

            audioStatus.innerHTML = '<span class="text-info">‚è≥ ƒêang t·∫°o audio...</span>';
            regenBtn.disabled = true;

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/slide/${slideNum}/regenerate_audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const audioPlayer = document.getElementById(`audioPlayer${slideNum}`);
                    const audio = document.getElementById(`audio${slideNum}`);

                    if (audioPlayer && audio) {
                        // Update audio source with cache busting
                        audio.src = data.audio_url + '?t=' + Date.now();
                        audioPlayer.style.display = 'block';
                    }

                    audioStatus.innerHTML = '<span class="text-success">‚úÖ Audio ƒë√£ ƒë∆∞·ª£c t·∫°o l·∫°i</span>';
                } else {
                    audioStatus.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Error regenerating audio:', error);
                audioStatus.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
            } finally {
                if (regenBtn) regenBtn.disabled = false;
            }
        }

        function showStep4Button() {
            // Show the next step button
            const nextStepBtn = document.getElementById('nextStepBtn');
            if (nextStepBtn) {
                nextStepBtn.style.display = 'inline-block';
            }
        }

        function goToStep4() {
            // TODO: Implement Step 4 - Avatar Upload
            alert('B∆∞·ªõc 4 (Upload Avatar) s·∫Ω ƒë∆∞·ª£c implement ti·∫øp theo. Presentation ID: ' + currentPresentationId);
        }

        // ============== VOICE SETTINGS FUNCTIONS ==============

        async function loadAvailableVoices() {
            try {
                const response = await fetch('/api/available-voices');
                const data = await response.json();

                const select = document.getElementById('presetVoiceSelect');
                select.innerHTML = ''; // Clear existing

                if (data.success && data.voices && data.voices.length > 0) {
                    availableVoices = data.voices;
                    select.innerHTML = '<option value="">-- Select a voice --</option>';

                    data.voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.id;
                        option.textContent = voice.name;
                        select.appendChild(option);
                    });
                    console.log(`Loaded ${data.voices.length} VieNeu voices`);
                } else {
                    console.warn('VieNeu-TTS not available, using gTTS');
                    // Show message in dropdown
                    select.innerHTML = '<option value="" disabled selected>üö´ No preset voices available (Standard TTS only)</option>';
                    // Optionally disable the radio button for preset
                    // document.getElementById('voiceTypePreset').disabled = true;
                    // document.getElementById('voiceTypeDefault').checked = true;
                    // toggleVoiceSections();
                }
            } catch (error) {
                console.error('Error loading voices:', error);
                const select = document.getElementById('presetVoiceSelect');
                select.innerHTML = '<option value="" disabled selected>‚ùå Error loading voices</option>';
            }
        }


        function openVoiceSettings() {
            // Updated for Global Settings
            // Reset to default or load last global settings
            const saved = voiceSettings['global'] || { type: 'default' };

            document.getElementById('voiceTypeDefault').checked = saved.type === 'default';
            document.getElementById('voiceTypePreset').checked = saved.type === 'preset';
            document.getElementById('voiceTypeClone').checked = saved.type === 'clone';

            if (saved.voice_id) {
                document.getElementById('presetVoiceSelect').value = saved.voice_id;
            }

            toggleVoiceSections();

            const modal = new bootstrap.Modal(document.getElementById('voiceSettingsModal'));
            modal.show();
        }

        function toggleVoiceSections() {
            const voiceType = document.querySelector('input[name="voiceType"]:checked').value;
            const presetSection = document.getElementById('presetVoiceSection');
            const cloneSection = document.getElementById('cloneVoiceSection');

            presetSection.style.display = voiceType === 'preset' ? 'block' : 'none';
            cloneSection.style.display = voiceType === 'clone' ? 'block' : 'none';
        }

        async function previewVoice() {
            const text = document.getElementById('previewText').value;
            if (!text.trim()) {
                alert('Please enter text to preview');
                return;
            }

            const statusDiv = document.getElementById('previewStatus');
            const audioContainer = document.getElementById('previewAudioContainer');
            const audioPlayer = document.getElementById('previewAudioPlayer');

            statusDiv.innerHTML = '<span class="text-info">‚è≥ Generating preview...</span>';
            audioContainer.style.display = 'block';

            const voiceType = document.querySelector('input[name="voiceType"]:checked').value;

            const formData = new FormData();
            formData.append('text', text);
            formData.append('voiceType', voiceType);

            if (voiceType === 'preset') {
                const voiceId = document.getElementById('presetVoiceSelect').value;
                if (!voiceId) {
                    alert('Please select a preset voice');
                    return;
                }
                formData.append('voice_id', voiceId);
            } else if (voiceType === 'clone') {
                const fileInput = document.getElementById('cloneVoiceFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('Please upload an audio file for voice cloning');
                    return;
                }
                formData.append('clone_file', fileInput.files[0]);
            }

            try {
                const response = await fetch('/api/preview-voice', {
                    method: 'POST',
                    body: formData // Send as FormData (browser sets boundary)
                });

                const data = await response.json();

                if (data.success) {
                    audioPlayer.src = data.audio_url + '?t=' + Date.now();
                    audioPlayer.play();
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ Playing preview</span>';
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå Error: ${data.error}</span>`;
                }
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Add event listeners for voice type radio buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="voiceType"]').forEach(radio => {
                radio.addEventListener('change', toggleVoiceSections);
            });

            // Load available voices on page load
            loadAvailableVoices();
        });

        async function applyAndGenerateAll() {
            const voiceType = document.querySelector('input[name="voiceType"]:checked').value;
            const settings = { type: voiceType };

            if (voiceType === 'preset') {
                settings.voice_id = document.getElementById('presetVoiceSelect').value;
                if (!settings.voice_id) {
                    alert('Please select a preset voice');
                    return;
                }
            } else if (voiceType === 'clone') {
                const fileInput = document.getElementById('cloneVoiceFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('Please upload an audio file for voice cloning');
                    return;
                }
                settings.clone_file = fileInput.files[0];
            }

            // Save global settings
            voiceSettings['global'] = settings;

            // Close modal
            const modalElement = document.getElementById('voiceSettingsModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();

            // Trigger Generate All Audio with settings
            await generateAllAudioWithSettings(settings);
        }

        async function generateAllAudioWithSettings(settings) {
            if (!currentPresentationId) {
                alert('Kh√¥ng t√¨m th·∫•y presentation!');
                return;
            }

            showLoading('ƒêang t·∫°o audio cho t·∫•t c·∫£ slides...');

            try {
                // Prepare request body with voice settings
                const requestBody = { ...settings };
                // Remove file object if present (cannot send in JSON like this, need separate handling or assume preset for now)
                if (requestBody.clone_file) delete requestBody.clone_file;

                const response = await fetch(`/api/presentation/${currentPresentationId}/generate_audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody) // Send settings to backend
                });

                const data = await response.json();

                if (data.success) {
                    // Update UI for each slide
                    data.results.forEach(result => {
                        const slideNum = result.slide_index;
                        // const audioStatus = document.getElementById(`audioStatus${slideNum}`); // Removed
                        const audioPlayer = document.getElementById(`audioPlayer${slideNum}`);
                        const audio = document.getElementById(`audio${slideNum}`);

                        if (result.success && result.audio_url) {
                            if (audio && audioPlayer) {
                                audio.src = result.audio_url + '?t=' + Date.now();
                                audioPlayer.style.display = 'block';
                            }
                        }
                    });

                    hideLoading();
                    alert(`ƒê√£ t·∫°o th√†nh c√¥ng audio cho ${data.success_count}/${data.total_slides} slides!`);

                    // Show next step button
                    showStep4Button();
                } else {
                    hideLoading();
                    alert('L·ªói khi t·∫°o audio: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error generating audio:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }
    </script>

</body>

</html>