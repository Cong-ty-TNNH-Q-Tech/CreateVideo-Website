<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Video Thuy·∫øt Tr√¨nh - Step 1: Upload Presentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1000px;
        }

        .step-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            background: white;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .upload-area {
            border: 2px dashed #0d6efd;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #e7f1ff;
            border-color: #0a58ca;
        }

        .upload-area.dragover {
            background: #cfe2ff;
            border-color: #0a58ca;
        }

        .slides-preview {
            margin-top: 2rem;
        }

        .slide-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }

        .slide-header {
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 0.5rem;
        }

        .slide-content {
            color: #6c757d;
            font-size: 0.9rem;
            max-height: 100px;
            overflow-y: auto;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        /* Video player visibility classes */
        .video-player-hidden {
            display: none !important;
        }
        
        .video-player-visible {
            display: block !important;
            min-height: 200px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #28a745;
        }
    </style>
</head>

<body>

    <div class="container py-5">
        <header class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary">T·∫°o Video Thuy·∫øt Tr√¨nh</h1>
            <p class="lead">T·ª± ƒë·ªông t·∫°o video thuy·∫øt tr√¨nh v·ªõi avatar n√≥i chuy·ªán</p>

            <!-- Navigation Links -->
            <div class="mt-3">
                <a href="/test/sadtalker" class="btn btn-outline-primary btn-sm me-2">üé¨ Test SadTalker</a>
                <a href="/test/tts" class="btn btn-outline-primary btn-sm">üé§ Test TTS</a>
            </div>
        </header>

        <!-- Step 1: Upload Presentation -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">1</div>
                <h3 class="mb-0">Upload File Presentation</h3>
            </div>

            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".pptx,.ppt,.pdf" style="display: none;">
                <div>
                    <svg width="64" height="64" fill="currentColor" class="text-primary mb-3" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5h2.767l12-12H.5a.5.5 0 0 1-.5.5v11.5z" />
                        <path
                            d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.74.439L8 13.069l-5.26 2.87A.5.5 0 0 1 2 15.5V2z" />
                    </svg>
                    <h4>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h4>
                    <p class="text-muted">H·ªó tr·ª£: .pptx, .ppt, .pdf</p>
                    <p class="text-muted">K√≠ch th∆∞·ªõc t·ªëi ƒëa: 100MB</p>
                </div>
            </div>

            <div id="fileInfo" style="display: none;" class="mt-3">
                <div class="alert alert-info">
                    <strong>File ƒë√£ ch·ªçn:</strong> <span id="fileName"></span>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearFile()">X√≥a</button>
                </div>
            </div>

            <div class="text-center mt-3">
                <button id="uploadBtn" class="btn btn-primary btn-lg" disabled onclick="uploadPresentation()">
                    üì§ Upload v√† ƒê·ªçc File
                </button>
            </div>
        </div>

        <!-- Slides Preview -->
        <div id="slidesPreview" class="step-card" style="display: none;">
            <div class="step-header">
                <div class="step-number">‚úì</div>
                <h3 class="mb-0">N·ªôi dung ƒë√£ ƒë·ªçc ƒë∆∞·ª£c</h3>
            </div>

            <div id="slidesList" class="slides-preview"></div>

            <div class="text-center mt-4">
                <button class="btn btn-success btn-lg" onclick="goToStep2()">
                    Ti·∫øp t·ª•c ‚Üí B∆∞·ªõc 2: Generate Text
                </button>
            </div>
        </div>

        <!-- Step 2: Generate & Edit Text -->
        <div id="step2Section" class="step-card" style="display: none;">
            <div class="step-header">
                <div class="step-number">2</div>
                <h3 class="mb-0">Generate & Edit Text Thuy·∫øt Tr√¨nh</h3>
            </div>

            <div class="alert alert-info">
                <strong>üí° H∆∞·ªõng d·∫´n:</strong>
                <ul class="mb-0">
                    <li>Click "Generate Script" ƒë·ªÉ t·∫°o k·ªãch b·∫£n thuy·∫øt tr√¨nh t·ª± ƒë·ªông t·ª´ n·ªôi dung slide</li>
                    <li>B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a k·ªãch b·∫£n sau khi generate</li>
                    <li>Click "Save" ƒë·ªÉ l∆∞u k·ªãch b·∫£n ƒë√£ ch·ªânh s·ª≠a</li>
                    <li>Sau khi ho√†n t·∫•t, click "Save All Scripts & Continue" ƒë·ªÉ chuy·ªÉn sang b∆∞·ªõc ti·∫øp theo</li>
                </ul>
            </div>

            <div id="slidesTextContainer"></div>

            <div class="text-center mt-4">
                <button class="btn btn-warning btn-lg me-2" onclick="saveAllScripts()">
                    üíæ Save All Scripts
                </button>
                <button class="btn btn-success btn-lg me-2" onclick="saveAllScriptsAndContinue()" id="continueToAudioBtn">
                    üíæ Save All Scripts & Continue ‚Üí
                </button>
                <button class="btn btn-outline-secondary btn-lg" onclick="goToStep3()">
                    ‚è≠Ô∏è Skip to Audio/Video
                </button>
            </div>
        </div>

        <!-- Step 3: Generate Audio & Video (NEW) -->
        <div id="step3Section" class="step-card" style="display: none;">
            <div class="step-header">
                <div class="step-number">3</div>
                <h3 class="mb-0">Generate Audio & Video</h3>
            </div>

            <div class="alert alert-info">
                <strong>üí° H∆∞·ªõng d·∫´n:</strong>
                <ul class="mb-0">
                    <li>Click "Generate Audio" ƒë·ªÉ t·∫°o audio cho t·∫•t c·∫£ slides</li>
                    <li>Sau khi c√≥ audio, click "Generate Video" cho t·ª´ng slide ƒë·ªÉ xem preview</li>
                    <li>Ho√†n t·∫•t sau ƒë√≥ chuy·ªÉn sang b∆∞·ªõc cu·ªëi ƒë·ªÉ merge ho·∫∑c t·∫°o talking head video</li>
                </ul>
            </div>

            <div class="text-center mb-4">
                <button class="btn btn-success btn-lg" onclick="openVoiceSettings()">
                    üéµ Generate Audio for All Slides
                </button>
            </div>

            <!-- Slides will be loaded here dynamically -->
            <div id="slidesAudioVideoContainer"></div>

            <!-- Persistent Full Audio Player -->
            <div class="mt-4" id="fullPresentationAudioContainer" style="display:none;">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üéµ Full Presentation Preview</h5>
                    </div>
                    <div class="card-body bg-light">
                        <audio id="persistentFullAudioPlayer" controls class="w-100"></audio>
                        <p class="text-muted small mb-0 mt-2">This is the combined audio of all slides.</p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg" onclick="goToStep4()" id="continueToFinalVideoBtn" style="display:none;">
                    Ti·∫øp t·ª•c ‚Üí B∆∞·ªõc 4: Final Video Generation
                </button>
            </div>
        </div>

        <!-- Step 4: Upload Avatar (HIDDEN - Avatar upload moved to Talking Head option) -->
    <div id="step4Section" class="step-card" style="display: none !important;">
        <div class="step-header">
            <div class="step-number">4</div>
            <h3 class="mb-0">Upload Avatar</h3>
        </div>

        <div class="alert alert-info">
            <strong>üí° Instruction:</strong> Upload a clear image of a face (Portrait) to generate the video which
            matches the audio.
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card p-4 text-center">
                    <div id="avatarPreviewContainer" class="mb-3"
                        style="min-height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                        <p class="text-muted" id="avatarPlaceholder">No avatar selected</p>
                        <img id="avatarPreview" src="" class="img-fluid rounded shadow-sm"
                            style="max-height: 300px; display: none;">
                    </div>

                    <div class="mb-3 text-start">
                        <label for="avatarInput" class="form-label fw-bold">Select Avatar Image (JPG/PNG):</label>
                        <input type="file" class="form-control" id="avatarInput"
                            accept="image/png, image/jpeg, image/jpg">
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="uploadAvatar()" id="uploadAvatarBtn">
                            üñºÔ∏è Confirm & Upload Avatar
                        </button>
                    </div>
                    <div id="avatarStatus" class="mt-2"></div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button class="btn btn-success btn-lg" onclick="goToStep5()" id="step5Btn" style="display: none;">
                üé¨ Next: Generate Video (Step 5)
            </button>
        </div>
    </div>

    <!-- Step 4: Generate Video - Choose Method -->
    <div id="step5Section" class="step-card" style="display: none;">
        <div class="step-header">
            <div class="step-number">4</div>
            <h3 class="mb-0">Generate Final Video</h3>
        </div>

        <div class="alert alert-info">
            <strong>üé¨ Choose your video generation method:</strong><br>
            Select how you want to create your final video presentation.
        </div>

        <div class="row">
            <!-- Option A: Presentation Video (Slides + Audio) -->
            <div class="col-md-6 mb-4">
                <div class="card h-100 border-primary" style="cursor: pointer;"
                    onclick="document.getElementById('mergeVideosBtn').click()">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-file-powerpoint" style="font-size: 3rem; color: #0d6efd;"></i>
                        </div>
                        <h4>üìä Merge Slide Videos</h4>
                        <p class="text-muted">Combine All Slide Videos</p>
                        <ul class="text-left">
                            <li>Merge t·∫•t c·∫£ slide videos ƒë√£ t·∫°o</li>
                            <li>T·∫°o video ho√†n ch·ªânh t·ª´ c√°c slide</li>
                            <li>Gi·ªØ nguy√™n ch·∫•t l∆∞·ª£ng v√† transitions</li>
                            <li>T·ª± ƒë·ªông s·∫Øp x·∫øp theo th·ª© t·ª± slides</li>
                            <li><strong>C·∫ßn t·∫°o video cho slides tr∆∞·ªõc</strong></li>
                        </ul>
                        <button class="btn btn-primary btn-lg mt-3" onclick="mergeAllSlideVideos()"
                            id="mergeVideosBtn">
                            üé¨ Merge All Slide Videos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Option B: Talking Head Video (SadTalker) -->
            <div class="col-md-6 mb-4">
                <div class="card h-100 border-success">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-user-tie" style="font-size: 3rem; color: #198754;"></i>
                        </div>
                        <h4>üé≠ Talking Head Video</h4>
                        <p class="text-muted">AI Avatar with SadTalker</p>
                        <ul class="text-left">
                            <li>T·∫°o video v·ªõi avatar n√≥i</li>
                            <li>AI ƒë·ªìng b·ªô m√¥i v√† bi·ªÉu c·∫£m</li>
                            <li>ƒê·ªô ph√¢n gi·∫£i 512px</li>
                            <li>Qu√° tr√¨nh: 2-5 ph√∫t</li>
                            <li><strong>C·∫ßn upload avatar tr∆∞·ªõc</strong></li>
                        </ul>
                        
                        <!-- Avatar Upload Section -->
                        <div class="mt-3 mb-3 text-start">
                            <label for="talkingHeadAvatarInput" class="form-label fw-bold">Upload Avatar (JPG/PNG):</label>
                            <div id="talkingHeadAvatarPreviewContainer" class="mb-2"
                                style="min-height: 150px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                                <p class="text-muted mb-0" id="talkingHeadAvatarPlaceholder">No avatar selected</p>
                                <img id="talkingHeadAvatarPreview" src="" class="img-fluid rounded shadow-sm"
                                    style="max-height: 200px; display: none;">
                            </div>
                            <input type="file" class="form-control" id="talkingHeadAvatarInput"
                                accept="image/png, image/jpeg, image/jpg">
                            <div id="talkingHeadAvatarStatus" class="mt-2 small"></div>
                        </div>
                        
                        <button class="btn btn-success btn-lg mt-3 w-100" onclick="uploadAvatarAndGenerateTalkingHead()"
                            id="talkingHeadVideoBtn">
                            ü§ñ Upload Avatar & Create Video
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status indicator (shared for both methods) -->
        <div id="videoStatus" class="alert alert-secondary text-center" style="display: none;">
            <div class="spinner-border text-primary mb-2" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mb-0" id="videoStatusText">ƒêang t·∫°o video...</p>
        </div>

        <div id="videoResultContainer" style="display: none;">
            <div class="alert alert-success">
                <strong>‚úÖ Video ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</strong>
            </div>

            <div class="ratio ratio-16x9 mb-3" style="border-radius: 8px; overflow: hidden; background: #000;">
                <video id="finalVideo" controls controlsList="nodownload">
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>

            <div class="d-grid gap-2">
                <a id="downloadVideoBtn" class="btn btn-success btn-lg" download>
                    ‚¨áÔ∏è Download Video
                </a>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>

    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h3 class="mt-3">ƒêang x·ª≠ l√Ω...</h3>
            <p class="text-muted" id="loadingText">Vui l√≤ng ƒë·ª£i</p>
        </div>
    </div>

    <!-- Voice Settings Modal -->
    <div class="modal fade" id="voiceSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üé§ Voice Settings & Generation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Voice Type Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Voice Type:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voiceType" id="voiceTypePreset"
                                value="preset" checked>
                            <label class="form-check-label" for="voiceTypePreset">
                                üë§ Preset Voice (VieNeu-TTS)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voiceType" id="voiceTypeClone"
                                value="clone">
                            <label class="form-check-label" for="voiceTypeClone">
                                üéôÔ∏è Clone Voice (Upload Audio)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="voiceType" id="voiceTypeDefault"
                                value="default">
                            <label class="form-check-label" for="voiceTypeDefault">
                                üîä Default (gTTS or Auto)
                            </label>
                        </div>
                    </div>

                    <!-- Preset Voice Selection -->
                    <div class="mb-3" id="presetVoiceSection">
                        <label class="form-label fw-bold">Choose Preset Voice:</label>
                        <select class="form-select" id="presetVoiceSelect">
                            <option value="">Loading voices...</option>
                        </select>
                        <small class="text-muted">Vietnamese voices from VieNeu-TTS</small>
                    </div>

                    <!-- Clone Voice Upload -->
                    <div class="mb-3" id="cloneVoiceSection" style="display: none;">
                        <label class="form-label fw-bold">Upload Audio for Voice Cloning:</label>
                        <input type="file" class="form-control" id="cloneVoiceFile" accept="audio/*">
                        <small class="text-muted">Upload a clear audio sample (3-10 seconds recommended)</small>
                        <div id="cloneUploadStatus" class="mt-2"></div>
                    </div>

                    <hr>

                    <!-- Preview Section -->
                    <div class="mb-3 p-3 bg-light rounded">
                        <label class="form-label fw-bold mb-2">üîä Voice Preview:</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="previewText"
                                value="Xin ch√†o, ƒë√¢y l√† gi·ªçng n√≥i m·∫´u." placeholder="Text to preview...">
                            <button class="btn btn-outline-primary" type="button" onclick="previewVoice()">
                                ‚ñ∂Ô∏è Play Preview
                            </button>
                        </div>
                        <div id="previewAudioContainer" class="mt-2 text-center" style="display:none;">
                            <audio id="previewAudioPlayer" controls class="w-100"></audio>
                            <div id="previewStatus" class="small mt-1"></div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <strong>üí° Tip:</strong> For best results with voice cloning, use a clear audio recording
                        without background noise.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="applyAndGenerateAll()">
                        üöÄ OK - Generate Audio for All Slides
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <h5 class="mb-3">Generating Audio...</h5>
                    <div class="progress mb-3">
                        <div id="generationProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="progressStatus" class="text-muted mb-0">Starting...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPresentationId = null;
        let selectedFile = null;
        let voiceSettings = {}; // Store voice settings per slide: { slideNum: { type, voice_id, clone_path } }
        let currentModalSlide = null; // Track which slide is being configured
        let availableVoices = []; // Cache of available VieNeu voices

        // File input handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');

        // Click to select file
        uploadArea.addEventListener('click', () => fileInput.click());

        // File selected
        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileInfo.style.display = 'block';
                uploadBtn.disabled = false;
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.pptx') || file.name.endsWith('.ppt') || file.name.endsWith('.pdf'))) {
                selectedFile = file;
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = file.name;
                fileInfo.style.display = 'block';
                uploadBtn.disabled = false;
            } else {
                alert('Vui l√≤ng ch·ªçn file .pptx, .ppt ho·∫∑c .pdf');
            }
        });

        function clearFile() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadBtn.disabled = true;
        }

        async function uploadPresentation() {
            if (!selectedFile) {
                alert('Vui l√≤ng ch·ªçn file');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);

            showLoading('ƒêang upload v√† ƒë·ªçc file...');

            try {
                const response = await fetch('/api/upload-presentation', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentPresentationId = data.presentation_id;
                    displaySlides(data.slides);
                    hideLoading();
                } else {
                    hideLoading();
                    alert('L·ªói: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        function displaySlides(slides) {
            const slidesList = document.getElementById('slidesList');
            slidesList.innerHTML = '';

            slides.forEach(slide => {
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide-item';
                slideDiv.innerHTML = `
                <div class="slide-header">Slide ${slide.slide_num} / ${slide.total_slides}</div>
                <div class="slide-content">${slide.content || '(Kh√¥ng c√≥ n·ªôi dung)'}</div>
            `;
                slidesList.appendChild(slideDiv);
            });

            document.getElementById('slidesPreview').style.display = 'block';
        }

        function goToStep2() {
            if (currentPresentationId) {
                // L∆∞u presentation ID v√†o sessionStorage
                sessionStorage.setItem('presentationId', currentPresentationId);
                // Hi·ªÉn th·ªã Step 2
                document.getElementById('step2Section').style.display = 'block';
                document.getElementById('step2Section').scrollIntoView({ behavior: 'smooth' });
                // Load slides ƒë·ªÉ generate text
                loadSlidesForStep2();
            }
        }

        async function loadSlidesForStep2() {
            if (!currentPresentationId) return;

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/slides`);
                const data = await response.json();

                if (data.success) {
                    displaySlidesForStep2(data.slides);

                    // Show persistent audio if exists
                    if (data.full_audio_url) {
                        const persistentContainer = document.getElementById('fullPresentationAudioContainer');
                        const persistentPlayer = document.getElementById('persistentFullAudioPlayer');
                        if (persistentContainer && persistentPlayer) {
                            persistentPlayer.src = data.full_audio_url;
                            persistentContainer.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading slides:', error);
            }
        }

        function displaySlidesForStep2(slides) {
            const slidesContainer = document.getElementById('slidesTextContainer');
            slidesContainer.innerHTML = '';

            slides.forEach(slide => {
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide-text-item mb-4';
                slideDiv.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Slide ${slide.slide_num} / ${slide.total_slides}</h5>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="generateText(${slide.slide_num})">
                                ‚ú® Generate Script
                            </button>
                            <button class="btn btn-sm btn-success ms-2" onclick="saveText(${slide.slide_num})" style="display:none;" id="saveBtn${slide.slide_num}">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <small class="text-muted">N·ªôi dung slide g·ªëc:</small>
                            <div class="bg-light p-2 rounded" style="max-height: 100px; overflow-y: auto;">
                                ${slide.content || '(Kh√¥ng c√≥ n·ªôi dung)'}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">K·ªãch b·∫£n thuy·∫øt tr√¨nh (Plain text suitable for TTS):</label>
                            <textarea 
                                class="form-control script-textarea" 
                                id="textArea${slide.slide_num}" 
                                data-slide-num="${slide.slide_num}"
                                rows="5" 
                                placeholder="Click 'Generate Script' ƒë·ªÉ t·∫°o k·ªãch b·∫£n thuy·∫øt tr√¨nh..."
                                oninput="markAsEdited(${slide.slide_num})"
                            >${slide.edited_text || slide.generated_text || ''}</textarea>
                        </div>
                        

                        

                        
                        <div id="textStatus${slide.slide_num}" class="text-muted small"></div>
                    </div>
                </div>
            `;
                slidesContainer.appendChild(slideDiv);


                

            });
        }

        async function generateText(slideNum) {
            if (!currentPresentationId) return;

            const textArea = document.getElementById(`textArea${slideNum}`);
            const statusDiv = document.getElementById(`textStatus${slideNum}`);
            const saveBtn = document.getElementById(`saveBtn${slideNum}`);

            statusDiv.innerHTML = '<span class="text-info">‚è≥ ƒêang generate script...</span>';
            textArea.disabled = true;

            try {
                const response = await fetch('/api/generate-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        presentation_id: currentPresentationId,
                        slide_num: slideNum,
                        language: 'vi'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    textArea.value = data.text;
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ Script generated!</span>';
                    saveBtn.style.display = 'inline-block';
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Error generating script:', error);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
            } finally {
                textArea.disabled = false;
            }
        }

        function markAsEdited(slideNum) {
            const saveBtn = document.getElementById(`saveBtn${slideNum}`);
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
            }
        }

        async function saveText(slideNum) {
            if (!currentPresentationId) return;

            const textArea = document.getElementById(`textArea${slideNum}`);
            const statusDiv = document.getElementById(`textStatus${slideNum}`);
            const saveBtn = document.getElementById(`saveBtn${slideNum}`);

            statusDiv.innerHTML = '<span class="text-info">‚è≥ ƒêang l∆∞u...</span>';

            try {
                const response = await fetch('/api/save-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        presentation_id: currentPresentationId,
                        slide_num: slideNum,
                        edited_text: textArea.value
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ ƒê√£ l∆∞u!</span>';
                    saveBtn.style.display = 'none';
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Error saving text:', error);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
            }
        }

        async function saveAllScripts() {
            if (!currentPresentationId) return;

            const textAreas = document.querySelectorAll('.script-textarea');
            const slidesData = [];

            textAreas.forEach(area => {
                const slideNum = area.getAttribute('data-slide-num');
                const text = area.value;
                if (slideNum) {
                    slidesData.push({
                        slide_num: parseInt(slideNum),
                        text: text
                    });
                }
            });

            if (slidesData.length === 0) {
                alert("Kh√¥ng c√≥ script n√†o ƒë·ªÉ l∆∞u.");
                return;
            }

            showLoading('ƒêang l∆∞u t·∫•t c·∫£ scripts...');

            try {
                const response = await fetch('/api/save-all-texts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        presentation_id: currentPresentationId,
                        slides_data: slidesData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`ƒê√£ l∆∞u th√†nh c√¥ng ${data.saved_count} scripts!`);
                    // Hide individual save buttons
                    textAreas.forEach(area => {
                        const slideNum = area.getAttribute('data-slide-num');
                        const saveBtn = document.getElementById(`saveBtn${slideNum}`);
                        if (saveBtn) saveBtn.style.display = 'none';
                        const statusDiv = document.getElementById(`textStatus${slideNum}`);
                        if (statusDiv) statusDiv.innerHTML = '<span class="text-success">‚úÖ ƒê√£ l∆∞u!</span>';
                    });
                } else {
                    alert('L·ªói khi l∆∞u: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving all scripts:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showLoading(text = 'ƒêang x·ª≠ l√Ω...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function goToStep3() {
            if (currentPresentationId) {
                // First generate audio for all slides
                generateAllAudio();
            }
        }

        // ============== AUDIO FUNCTIONS ==============

        async function generateAllAudio() {
            if (!currentPresentationId) {
                alert('Kh√¥ng t√¨m th·∫•y presentation!');
                return;
            }

            showLoading('ƒêang t·∫°o audio cho t·∫•t c·∫£ slides...');

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/generate_audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Update UI for each slide
                    data.results.forEach(result => {
                        const slideNum = result.slide_index;
                        const audioStatus = document.getElementById(`audioStatus${slideNum}`);
                        const audioPlayer = document.getElementById(`audioPlayer${slideNum}`);
                        const audio = document.getElementById(`audio${slideNum}`);

                        // Check if elements exist before updating
                        if (!audioStatus) {
                            console.warn(`Audio elements not found for slide ${slideNum}`);
                            return;
                        }

                        if (result.success && result.audio_url) {
                            audioStatus.innerHTML = '<span class="text-success">‚úÖ Audio ƒë√£ t·∫°o</span>';
                            if (audio && audioPlayer) {
                                audio.src = result.audio_url;
                                audioPlayer.style.display = 'block';
                            }
                        } else {
                            audioStatus.innerHTML = `<span class="text-warning">‚ö†Ô∏è ${result.message}</span>`;
                        }
                    });

                    hideLoading();
                    alert(`ƒê√£ t·∫°o th√†nh c√¥ng audio cho ${data.success_count}/${data.total_slides} slides! B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c b∆∞·ªõc 4: Upload Avatar.`);

                    // Show next step button
                    showStep4Button();
                } else {
                    hideLoading();
                    alert('L·ªói khi t·∫°o audio: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                console.error('Error generating audio:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        async function regenerateAudio(slideNum) {
            if (!currentPresentationId) return;

            const audioStatus = document.getElementById(`audioStatus${slideNum}`);
            const regenBtn = document.getElementById(`regenAudioBtn${slideNum}`);

            if (!audioStatus || !regenBtn) {
                console.error(`Audio elements not found for slide ${slideNum}`);
                return;
            }

            audioStatus.innerHTML = '<span class="text-info">‚è≥ ƒêang t·∫°o audio...</span>';
            regenBtn.disabled = true;

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/slide/${slideNum}/regenerate_audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const audioPlayer = document.getElementById(`audioPlayer${slideNum}`);
                    const audio = document.getElementById(`audio${slideNum}`);

                    if (audioPlayer && audio) {
                        // Update audio source with cache busting
                        audio.src = data.audio_url + '?t=' + Date.now();
                        audioPlayer.style.display = 'block';
                    }

                    audioStatus.innerHTML = '<span class="text-success">‚úÖ Audio ƒë√£ ƒë∆∞·ª£c t·∫°o l·∫°i</span>';
                } else {
                    audioStatus.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Error regenerating audio:', error);
                audioStatus.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
            } finally {
                if (regenBtn) regenBtn.disabled = false;
            }
        }

        function showStep4Button() {
            // Show the continue button in Step 3
            const continueBtn = document.getElementById('continueToFinalVideoBtn');
            if (continueBtn) {
                continueBtn.style.display = 'inline-block';
            }
        }

        function goToStep4() {
            // Step 4 removed - go directly to Step 5 (video generation)
            goToStep5();
        }

        // ============== VOICE SETTINGS FUNCTIONS ==============

        async function loadAvailableVoices() {
            try {
                const response = await fetch('/api/available-voices');
                const data = await response.json();

                const select = document.getElementById('presetVoiceSelect');
                select.innerHTML = ''; // Clear existing

                if (data.success && data.voices && data.voices.length > 0) {
                    availableVoices = data.voices;
                    select.innerHTML = '<option value="">-- Select a voice --</option>';

                    data.voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.id;
                        option.textContent = voice.name;
                        select.appendChild(option);
                    });
                    console.log(`Loaded ${data.voices.length} VieNeu voices`);
                } else {
                    console.warn('VieNeu-TTS not available, using gTTS');
                    // Show message in dropdown
                    select.innerHTML = '<option value="" disabled selected>üö´ No preset voices available (Standard TTS only)</option>';
                    // Optionally disable the radio button for preset
                    // document.getElementById('voiceTypePreset').disabled = true;
                    // document.getElementById('voiceTypeDefault').checked = true;
                    // toggleVoiceSections();
                }
            } catch (error) {
                console.error('Error loading voices:', error);
                const select = document.getElementById('presetVoiceSelect');
                select.innerHTML = '<option value="" disabled selected>‚ùå Error loading voices</option>';
            }
        }


        function openVoiceSettings() {
            // Updated for Global Settings
            // Reset to default or load last global settings
            const saved = voiceSettings['global'] || { type: 'default' };

            document.getElementById('voiceTypeDefault').checked = saved.type === 'default';
            document.getElementById('voiceTypePreset').checked = saved.type === 'preset';
            document.getElementById('voiceTypeClone').checked = saved.type === 'clone';

            if (saved.voice_id) {
                document.getElementById('presetVoiceSelect').value = saved.voice_id;
            }

            toggleVoiceSections();

            const modal = new bootstrap.Modal(document.getElementById('voiceSettingsModal'));
            modal.show();
        }

        function toggleVoiceSections() {
            const voiceType = document.querySelector('input[name="voiceType"]:checked').value;
            const presetSection = document.getElementById('presetVoiceSection');
            const cloneSection = document.getElementById('cloneVoiceSection');

            presetSection.style.display = voiceType === 'preset' ? 'block' : 'none';
            cloneSection.style.display = voiceType === 'clone' ? 'block' : 'none';
        }

        async function previewVoice() {
            const text = document.getElementById('previewText').value;
            if (!text.trim()) {
                alert('Please enter text to preview');
                return;
            }

            const statusDiv = document.getElementById('previewStatus');
            const audioContainer = document.getElementById('previewAudioContainer');
            const audioPlayer = document.getElementById('previewAudioPlayer');

            statusDiv.innerHTML = '<span class="text-info">‚è≥ Generating preview...</span>';
            audioContainer.style.display = 'block';

            const voiceType = document.querySelector('input[name="voiceType"]:checked').value;

            const formData = new FormData();
            formData.append('text', text);
            formData.append('voiceType', voiceType);

            if (voiceType === 'preset') {
                const voiceId = document.getElementById('presetVoiceSelect').value;
                if (!voiceId) {
                    alert('Please select a preset voice');
                    return;
                }
                formData.append('voice_id', voiceId);
            } else if (voiceType === 'clone') {
                const fileInput = document.getElementById('cloneVoiceFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('Please upload an audio file for voice cloning');
                    return;
                }
                formData.append('clone_file', fileInput.files[0]);
            }

            try {
                const response = await fetch('/api/preview-voice', {
                    method: 'POST',
                    body: formData // Send as FormData (browser sets boundary)
                });

                const data = await response.json();

                if (data.success) {
                    audioPlayer.src = data.audio_url + '?t=' + Date.now();
                    audioPlayer.play();
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ Playing preview</span>';
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå Error: ${data.error}</span>`;
                }
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function checkAndEnableContinueButton() {
            if (!currentPresentationId) return;
            
            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}`);
                const data = await response.json();
                
                if (data.success) {
                    const slides = data.presentation.slides || [];
                    const hasAudioVideo = slides.some(s => s.audio_url && s.slide_video_url);
                    
                    const continueBtn = document.getElementById('continueToFinalVideoBtn');
                    if (continueBtn && hasAudioVideo) {
                        continueBtn.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error checking continue button:', error);
            }
        }

        // Add event listeners for voice type radio buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="voiceType"]').forEach(radio => {
                radio.addEventListener('change', toggleVoiceSections);
            });

            // Load available voices on page load
            loadAvailableVoices();
        });

        async function applyAndGenerateAll() {
            const voiceType = document.querySelector('input[name="voiceType"]:checked').value;
            const settings = { type: voiceType };

            if (voiceType === 'preset') {
                settings.voice_id = document.getElementById('presetVoiceSelect').value;
                if (!settings.voice_id) {
                    alert('Please select a preset voice');
                    return;
                }
            } else if (voiceType === 'clone') {
                const fileInput = document.getElementById('cloneVoiceFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('Please upload an audio file for voice cloning');
                    return;
                }
                settings.clone_file = fileInput.files[0];
            }

            // Save global settings
            voiceSettings['global'] = settings;

            // Close modal
            const modalElement = document.getElementById('voiceSettingsModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();

            // Trigger Generate All Audio with settings
            await generateAllAudioWithSettings(settings);
        }

        async function regenerateAudioWithSettings(slideNum, settings) {
            if (!currentPresentationId) return false;

            const audioStatus = document.getElementById(`audioStatus${slideNum}`);
            if (audioStatus) {
                audioStatus.innerHTML = '<span class="text-info">‚è≥ Generating...</span>';
            }

            try {
                const requestBody = {};

                if (settings.type === 'preset' && settings.voice_id) {
                    requestBody.voice_id = settings.voice_id;
                } else if (settings.type === 'clone' && settings.clone_file) {
                    // Placeholder for when clone is fully implemented for batch
                    // requestBody.clone_voice_path = ...
                }

                const response = await fetch(`/api/presentation/${currentPresentationId}/slide/${slideNum}/regenerate_audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    const audioPlayer = document.getElementById(`audioPlayer${slideNum}`);
                    const audio = document.getElementById(`audio${slideNum}`);
                    if (audioPlayer && audio) {
                        audio.src = data.audio_url + '?t=' + Date.now();
                        audioPlayer.style.display = 'block';
                    }

                    if (audioStatus) {
                        audioStatus.innerHTML = '<span class="text-success">‚úÖ Done</span>';
                    }
                    
                    // Enable video generation button in Step 3
                    const videoBtn = document.getElementById(`genVideoBtn${slideNum}`);
                    if (videoBtn) {
                        videoBtn.disabled = false;
                        videoBtn.removeAttribute('title');
                    }

                    return true;
                } else {
                    if (audioStatus) {
                        audioStatus.innerHTML = `<span class="text-danger">‚ùå ${data.error || 'Failed'}</span>`;
                    }
                    return false;
                }
            } catch (error) {
                console.error('Error regenerating audio:', error);
                if (audioStatus) audioStatus.innerHTML = `<span class="text-danger">‚ùå Error: ${error.message}</span>`;
                return false;
            }
        }

        async function generateAllAudioWithSettings(settings) {
            if (!currentPresentationId) {
                alert('Kh√¥ng t√¨m th·∫•y presentation!');
                return;
            }

            // Show Progress Modal
            const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
            progressModal.show();

            const progressBar = document.getElementById('generationProgressBar');
            const progressStatus = document.getElementById('progressStatus');

            progressBar.style.width = '0%';
            progressStatus.textContent = 'Initializing...';

            try {
                // Get all slides that need generation
                // We can know total slides from DOM
                const scriptTextAreas = document.querySelectorAll('.script-textarea');
                const totalSlides = scriptTextAreas.length;
                let successCount = 0;

                // Sequential Generation
                for (let i = 0; i < totalSlides; i++) {
                    const slideNum = scriptTextAreas[i].getAttribute('data-slide-num');

                    // Update Status
                    progressStatus.textContent = `Generating audio for Slide ${slideNum} (${i + 1}/${totalSlides})...`;

                    // Call generation
                    const success = await regenerateAudioWithSettings(slideNum, settings);
                    if (success) successCount++;

                    // Update Progress Bar
                    const percent = Math.round(((i + 1) / totalSlides) * 90); // Go up to 90%, reserve 10% for merge
                    progressBar.style.width = `${percent}%`;
                }

                // Merging Audio
                progressStatus.textContent = 'Merging all audio files into preview...';

                const response = await fetch(`/api/presentation/${currentPresentationId}/concatenate_audio`, {
                    method: 'POST'
                });
                const mergeData = await response.json();

                progressBar.style.width = '100%';

                // Hide Progress Modal
                // Allow small delay to see 100%
                await new Promise(r => setTimeout(r, 500));
                progressModal.hide();

                if (mergeData.success) {
                    // Update persistent player in Step 3
                    const persistentContainer = document.getElementById('fullPresentationAudioContainer');
                    const persistentPlayer = document.getElementById('persistentFullAudioPlayer');
                    if (persistentContainer && persistentPlayer) {
                        persistentPlayer.src = mergeData.audio_url + '?t=' + Date.now();
                        persistentContainer.style.display = 'block';
                    }
                    
                    // Reload Step 3 to show audio players and enable video buttons
                    const step3 = document.getElementById('step3Section');
                    if (step3 && step3.style.display === 'block') {
                        await loadSlidesForAudioVideo();
                    }
                    
                    // Show success message
                    alert('‚úÖ Audio generation complete! You can now generate videos for each slide.');
                } else {
                    console.error('Audio merge failed:', mergeData.error);
                }

                // Show Next Step button on main page regardless of merge success
                if (successCount > 0) {
                    showStep4Button();
                }

            } catch (error) {
                progressModal.hide();
                console.error('Error generating audio:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        // --- Step 4 Logic ---

        function showStep4Button() {
            // Show the continue button in Step 3
            const continueBtn = document.getElementById('continueToFinalVideoBtn');
            if (continueBtn) continueBtn.style.display = 'inline-block';
        }

        function goToStep4() {
            // Step 4 removed - go directly to Step 5 (video generation)
            goToStep5();
        }

        async function uploadAvatar() {
            const fileInput = document.getElementById('avatarInput');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select an image file');
                return;
            }

            if (!currentPresentationId) {
                alert('Presentation ID missing');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]);

            const statusDiv = document.getElementById('avatarStatus');
            statusDiv.innerHTML = '<span class="text-info">‚è≥ Uploading...</span>';

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/upload_avatar`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ Avatar uploaded successfully!</span>';
                    document.getElementById('step5Btn').style.display = 'inline-block';
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå Error: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="text-danger">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Avatar Preview
        document.getElementById('avatarInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('avatarPreview');
                    img.src = e.target.result;
                    img.style.display = 'inline-block'; // changed from block to fix potential layout issues
                    document.getElementById('avatarPlaceholder').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        });

        // Avatar Preview for Talking Head
        document.getElementById('talkingHeadAvatarInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('talkingHeadAvatarPreview');
                    const placeholder = document.getElementById('talkingHeadAvatarPlaceholder');
                    img.src = e.target.result;
                    img.style.display = 'inline-block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        });

        function goToStep5() {
            const step5 = document.getElementById('step5Section');
            if (step5) {
                step5.style.display = 'block';
                step5.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Upload Avatar and Generate Talking Head Video (Combined)
        async function uploadAvatarAndGenerateTalkingHead() {
            const fileInput = document.getElementById('talkingHeadAvatarInput');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Vui l√≤ng ch·ªçn ·∫£nh avatar tr∆∞·ªõc!');
                return;
            }

            if (!currentPresentationId) {
                alert('Presentation ID missing');
                return;
            }

            const statusDiv = document.getElementById('talkingHeadAvatarStatus');
            const videoStatus = document.getElementById('videoStatus');
            const videoStatusText = document.getElementById('videoStatusText');
            const videoResultContainer = document.getElementById('videoResultContainer');
            const btn = document.getElementById('talkingHeadVideoBtn');

            // Step 1: Upload Avatar
            statusDiv.innerHTML = '<span class="text-info">‚è≥ Uploading avatar...</span>';
            btn.disabled = true;

            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]);

            try {
                const uploadResponse = await fetch(`/api/presentation/${currentPresentationId}/upload_avatar`, {
                    method: 'POST',
                    body: formData
                });
                const uploadData = await uploadResponse.json();

                if (!uploadData.success) {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå Upload failed: ${uploadData.error}</span>`;
                    btn.disabled = false;
                    return;
                }

                statusDiv.innerHTML = '<span class="text-success">‚úÖ Avatar uploaded!</span>';

                // Step 2: Generate Talking Head Video
                videoResultContainer.style.display = 'none';
                videoStatus.style.display = 'block';
                videoStatusText.textContent = 'ƒêang kh·ªüi t·∫°o SadTalker... Qu√° tr√¨nh c√≥ th·ªÉ m·∫•t 2-5 ph√∫t.';

                const videoResponse = await fetch(`/api/presentation/${currentPresentationId}/generate_video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const videoData = await videoResponse.json();

                if (videoData.success) {
                    // Hide loading
                    videoStatus.style.display = 'none';

                    // Show video result
                    const videoPlayer = document.getElementById('finalVideo');
                    const downloadBtn = document.getElementById('downloadVideoBtn');

                    videoPlayer.src = videoData.video_url + '?t=' + Date.now();
                    downloadBtn.href = videoData.video_url;
                    downloadBtn.download = `talking_head_${currentPresentationId}.mp4`;

                    videoResultContainer.style.display = 'block';

                    // Auto play
                    videoPlayer.play().catch(err => {
                        console.log('Auto-play prevented:', err);
                    });

                    // Success message
                    alert('‚úÖ ' + videoData.message);
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ Video created successfully!</span>';
                } else {
                    videoStatus.style.display = 'none';
                    alert('‚ùå L·ªói: ' + videoData.error);
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå Video generation failed: ${videoData.error}</span>`;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                videoStatus.style.display = 'none';
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå Error: ${error.message}</span>`;
                btn.disabled = false;
            }
        }

        // Presentation Video (Slides + Audio)
        async function generatePresentationVideo() {
            if (!currentPresentationId) {
                alert('Presentation ID missing');
                return;
            }

            const presentationBtn = document.getElementById('presentationVideoBtn');
            const videoStatus = document.getElementById('videoStatus');
            const videoStatusText = document.getElementById('videoStatusText');
            const videoResultContainer = document.getElementById('videoResultContainer');

            // Hide result if previously shown
            videoResultContainer.style.display = 'none';

            // Show loading status
            presentationBtn.disabled = true;
            videoStatus.style.display = 'block';
            videoStatusText.textContent = 'üìπ ƒêang t·∫°o presentation video... Vui l√≤ng ƒë·ª£i.';

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/export_presentation_video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Hide loading
                    videoStatus.style.display = 'none';

                    // Show video result
                    const videoPlayer = document.getElementById('finalVideo');
                    const downloadBtn = document.getElementById('downloadVideoBtn');

                    videoPlayer.src = data.video_url + '?t=' + Date.now();
                    downloadBtn.href = data.video_url;
                    downloadBtn.download = `presentation_${currentPresentationId}.mp4`;

                    videoResultContainer.style.display = 'block';

                    // Auto play
                    videoPlayer.play().catch(err => {
                        console.log('Auto-play prevented:', err);
                    });

                    // Success message
                    alert('‚úÖ ' + data.message);
                } else {
                    videoStatus.style.display = 'none';
                    alert('‚ùå L·ªói: ' + data.error);
                    presentationBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error generating presentation video:', error);
                videoStatus.style.display = 'none';
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
                presentationBtn.disabled = false;
            }
        }

        // Talking Head Video (SadTalker)
        async function generateTalkingHeadVideo() {
            if (!currentPresentationId) {
                alert('Presentation ID missing');
                return;
            }

            const talkingHeadBtn = document.getElementById('talkingHeadVideoBtn');
            const videoStatus = document.getElementById('videoStatus');
            const videoStatusText = document.getElementById('videoStatusText');
            const videoResultContainer = document.getElementById('videoResultContainer');

            // Hide result if previously shown
            videoResultContainer.style.display = 'none';

            // Show loading status
            talkingHeadBtn.disabled = true;
            videoStatus.style.display = 'block';
            videoStatusText.textContent = 'ƒêang kh·ªüi t·∫°o SadTalker... Qu√° tr√¨nh c√≥ th·ªÉ m·∫•t 2-5 ph√∫t.';

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/generate_video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Hide loading
                    videoStatus.style.display = 'none';

                    // Show video result
                    const videoPlayer = document.getElementById('finalVideo');
                    const downloadBtn = document.getElementById('downloadVideoBtn');

                    videoPlayer.src = data.video_url + '?t=' + Date.now();
                    downloadBtn.href = data.video_url;
                    downloadBtn.download = `talking_head_${currentPresentationId}.mp4`;

                    videoResultContainer.style.display = 'block';

                    // Auto play
                    videoPlayer.play().catch(err => {
                        console.log('Auto-play prevented:', err);
                    });

                    // Success message
                    alert('‚úÖ ' + data.message);
                } else {
                    videoStatus.style.display = 'none';
                    alert('‚ùå L·ªói: ' + data.error);
                    talkingHeadBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error generating video:', error);
                videoStatus.style.display = 'none';
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
                talkingHeadBtn.disabled = false;
            }
        }

        // Per-Slide Video Generation
        async function generateSlideVideo(slideNum) {
            if (!currentPresentationId) return;
            
            const btn = document.getElementById(`genVideoBtn${slideNum}`);
            const statusDiv = document.getElementById(`videoStatus${slideNum}`);
            const videoPlayer = document.getElementById(`videoPlayer${slideNum}`);
            const video = document.getElementById(`video${slideNum}`);
            
            // Save original button content and show loading spinner
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>ƒêang t·∫°o...';
            statusDiv.innerHTML = '<span class="text-info"><span class="spinner-border spinner-border-sm me-1"></span> ƒêang t·∫°o video cho slide ' + slideNum + '... Vui l√≤ng ƒë·ª£i.</span>';
            
            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/slide/${slideNum}/generate_slide_video`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Video generated successfully:', data.video_url);
                    console.log('Video element:', video);
                    console.log('VideoPlayer container before:', videoPlayer.className);
                    
                    // Set video source and force load
                    video.src = data.video_url + '?t=' + Date.now();
                    video.load(); // Force reload the video element
                    
                    // Show video player container using CSS class
                    videoPlayer.classList.remove('video-player-hidden');
                    videoPlayer.classList.add('video-player-visible');
                    
                    console.log('VideoPlayer container after:', videoPlayer.className);
                    
                    // Update status and button
                    statusDiv.innerHTML = '<span class="text-success">‚úÖ Video ƒë√£ t·∫°o</span>';
                    btn.innerHTML = '‚úÖ Ho√†n th√†nh';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    
                    console.log('Video src set to:', video.src);
                    
                    // Wait for video to be ready before playing
                    video.onloadeddata = function() {
                        console.log('Video loaded and ready to play');
                        video.play().catch(err => {
                            console.log('Auto-play prevented:', err);
                        });
                    };
                    
                    // Check if all slides have video to show continue button
                    checkAllSlidesHaveVideo();
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">‚ùå ${data.error}</span>`;
                    btn.innerHTML = originalBtnContent;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span class="text-danger">‚ùå ${error.message}</span>`;
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }
        
        // Helper function to check if all slides have video
        function checkAllSlidesHaveVideo() {
            // This will be used to enable the continue button when all videos are ready
            const allVideoStatuses = document.querySelectorAll('[id^="videoStatus"]');
            let allHaveVideo = true;
            allVideoStatuses.forEach(status => {
                if (!status.innerHTML.includes('‚úÖ')) {
                    allHaveVideo = false;
                }
            });
            
            const continueBtn = document.getElementById('continueToFinalVideoBtn');
            if (continueBtn && allHaveVideo) {
                continueBtn.style.display = 'inline-block';
            }
        }

        // Merge All Slide Videos
        async function mergeAllSlideVideos() {
            if (!currentPresentationId) {
                alert('Presentation ID missing');
                return;
            }
            
            const statusDiv = document.getElementById('videoStatus');
            const statusText = document.getElementById('videoStatusText');
            const resultContainer = document.getElementById('videoResultContainer');
            const mergeBtn = document.getElementById('mergeVideosBtn');
            
            // Hide previous results
            resultContainer.style.display = 'none';
            
            // Show loading
            if (mergeBtn) mergeBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info text-center';
            statusText.textContent = 'üé¨ ƒêang merge videos... Vui l√≤ng ƒë·ª£i.';
            
            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}/merge_slide_videos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.style.display = 'none';
                    resultContainer.style.display = 'block';
                    
                    const videoElement = document.getElementById('finalVideo');
                    const downloadBtn = document.getElementById('downloadVideoBtn');
                    
                    videoElement.src = data.video_url + '?t=' + Date.now();
                    downloadBtn.href = data.video_url;
                    downloadBtn.download = `final_presentation_${currentPresentationId}.mp4`;
                    
                    // Auto play
                    videoElement.play().catch(err => {
                        console.log('Auto-play prevented:', err);
                    });
                    
                    alert('‚úÖ ' + data.message);
                } else {
                    statusDiv.className = 'alert alert-danger text-center';
                    statusText.textContent = '‚ùå L·ªói: ' + data.error;
                    if (mergeBtn) mergeBtn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                statusDiv.className = 'alert alert-danger text-center';
                statusText.textContent = '‚ùå L·ªói k·∫øt n·ªëi: ' + error.message;
                if (mergeBtn) mergeBtn.disabled = false;
            }
        }

        // ============== STEP NAVIGATION FUNCTIONS ==============

        async function saveAllScriptsAndContinue() {
            if (!currentPresentationId) {
                alert('No presentation loaded');
                return;
            }

            // Get all script textareas
            const textareas = document.querySelectorAll('.script-textarea');
            
            // If no scripts generated yet, just go to Step 3
            if (textareas.length === 0) {
                const confirmSkip = confirm('B·∫°n ch∆∞a generate script n√†o. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c sang b∆∞·ªõc t·∫°o audio/video kh√¥ng?');
                if (confirmSkip) {
                    goToStep3();
                }
                return;
            }

            let saveCount = 0;
            let failCount = 0;

            // Show progress
            const continueBtn = document.getElementById('continueToAudioBtn');
            if (continueBtn) continueBtn.disabled = true;

            // Save all scripts
            for (let textarea of textareas) {
                const slideNum = parseInt(textarea.getAttribute('data-slide-num'));
                const success = await saveText(slideNum);
                if (success) {
                    saveCount++;
                } else {
                    failCount++;
                }
            }

            // Show result
            if (failCount > 0) {
                alert(`Saved ${saveCount} scripts, ${failCount} failed. Please check and try again.`);
                if (continueBtn) continueBtn.disabled = false;
            } else {
                alert(`‚úÖ Successfully saved ${saveCount} scripts!`);
                // Navigate to Step 3
                goToStep3();
            }
        }

        function goToStep3() {
            // Load slides for audio/video generation
            loadSlidesForAudioVideo();

            // Show Step 3
            const step3 = document.getElementById('step3Section');
            if (step3) {
                step3.style.display = 'block';
                step3.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function loadSlidesForAudioVideo() {
            if (!currentPresentationId) return;

            try {
                const response = await fetch(`/api/presentation/${currentPresentationId}`);
                const data = await response.json();

                if (!data.success) {
                    console.error('Failed to load presentation');
                    return;
                }

                const presentation = data.presentation;
                const slides = presentation.slides || [];
                const container = document.getElementById('slidesAudioVideoContainer');
                container.innerHTML = '';

                slides.forEach(slide => {
                    const slideDiv = document.createElement('div');
                    slideDiv.className = 'card mb-3';
                    
                    // Get script text
                    const scriptText = slide.edited_text || slide.generated_text || 'No script generated yet';
                    const displayText = scriptText.length > 200 ? scriptText.substring(0, 200) + '...' : scriptText;
                    
                    slideDiv.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">Slide ${slide.slide_num}</h5>
                            
                            <!-- Script Preview -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">üìù Script:</label>
                                <p class="text-muted small" style="white-space: pre-wrap;">${displayText}</p>
                            </div>

                            <!-- Audio Section -->
                            <div class="mb-3" id="audioSection${slide.slide_num}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">üéµ Audio Result:</label>
                                </div>
                                
                                <div id="audioPlayer${slide.slide_num}" style="display: none;">
                                    <audio controls class="w-100" id="audio${slide.slide_num}">
                                        <source src="" type="audio/wav">
                                    </audio>
                                </div>
                                
                                <div id="audioStatus${slide.slide_num}" class="text-muted small mt-2">
                                    ${slide.audio_url ? '<span class="text-success">‚úÖ Audio ƒë√£ t·∫°o</span>' : '<span class="text-info">‚ÑπÔ∏è Ch∆∞a t·∫°o audio</span>'}
                                </div>
                            </div>
                            
                            <!-- Video Section -->
                            <div class="mb-3" id="videoSection${slide.slide_num}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">üé¨ Slide Video Preview:</label>
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="generateSlideVideo(${slide.slide_num})" 
                                            id="genVideoBtn${slide.slide_num}"
                                            ${!slide.audio_url ? 'disabled title="Generate audio first"' : ''}>
                                        üé• Generate Video
                                    </button>
                                </div>
                                
                                <div id="videoPlayer${slide.slide_num}" class="video-player-hidden">
                                    <video controls class="w-100" id="video${slide.slide_num}" style="max-height: 300px; min-height: 200px; background: #000;">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                
                                <div id="videoStatus${slide.slide_num}" class="text-muted small mt-2">
                                    ${slide.slide_video_url ? '<span class="text-success">‚úÖ Video ƒë√£ t·∫°o</span>' : '<span class="text-info">‚ÑπÔ∏è Ch∆∞a t·∫°o video</span>'}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(slideDiv);

                    // Debug logging
                    console.log(`Slide ${slide.slide_num}:`, {
                        has_audio_url: !!slide.audio_url,
                        audio_url: slide.audio_url,
                        has_video_url: !!slide.slide_video_url
                    });

                    // Set up audio player if audio exists
                    if (slide.audio_url) {
                        // Use setTimeout to ensure DOM is ready
                        setTimeout(() => {
                            const audioPlayer = document.getElementById(`audioPlayer${slide.slide_num}`);
                            const audio = document.getElementById(`audio${slide.slide_num}`);
                            const audioStatus = document.getElementById(`audioStatus${slide.slide_num}`);
                            
                            console.log(`Setting up audio for slide ${slide.slide_num}:`, {
                                audioPlayer: !!audioPlayer,
                                audio: !!audio,
                                audioStatus: !!audioStatus
                            });
                            
                            if (audioPlayer && audio) {
                                audio.src = slide.audio_url;
                                audioPlayer.style.display = 'block';
                                console.log(`‚úÖ Audio player shown for slide ${slide.slide_num}`);
                                
                                // Hide the status text when audio player is shown
                                if (audioStatus) {
                                    audioStatus.style.display = 'none';
                                }
                            } else {
                                console.error(`‚ùå Could not find audio elements for slide ${slide.slide_num}`);
                            }
                        }, 100);
                    }
                    
                    // Set up video player if video exists
                    if (slide.slide_video_url) {
                        setTimeout(() => {
                            const videoPlayer = document.getElementById(`videoPlayer${slide.slide_num}`);
                            const video = document.getElementById(`video${slide.slide_num}`);
                            const videoStatus = document.getElementById(`videoStatus${slide.slide_num}`);
                            
                            if (videoPlayer && video) {
                                video.src = slide.slide_video_url;
                                videoPlayer.classList.remove('video-player-hidden');
                                videoPlayer.classList.add('video-player-visible');
                                console.log(`‚úÖ Video player shown for slide ${slide.slide_num}`);
                                
                                // Hide the status text when video player is shown
                                if (videoStatus) {
                                    videoStatus.style.display = 'none';
                                }
                            }
                        }, 100);
                    }
                });

                // Only show continue button if at least one slide has both audio and video
                const hasAudioVideo = slides.some(s => s.audio_url && s.slide_video_url);
                const continueBtn = document.getElementById('continueToFinalVideoBtn');
                if (continueBtn) {
                    continueBtn.style.display = hasAudioVideo ? 'inline-block' : 'none';
                }

            } catch (error) {
                console.error('Error loading slides:', error);
                alert('Failed to load slides: ' + error.message);
            }
        }

    </script>

</body>

</html>