<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LectureGen AI - Create Video</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

    <!-- Header & Nav -->
    <header class="container-fluid py-3 border-bottom border-secondary" style="border-color: var(--border-color) !important;">
        <div class="d-flex justify-content-between align-items-center mb-4">
             <div class="d-flex align-items-center gap-2">
                 <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                     <i class="bi bi-layers-fill"></i>
                 </div>
                 <h4 class="m-0 fw-bold">LectureGen AI</h4>
             </div>
             <div>
                 <button class="btn btn-sm btn-outline-secondary">Support</button>
                 <div class="d-inline-flex align-items-center justify-content-center bg-secondary bg-opacity-10 rounded-circle ms-2" style="width: 32px; height: 32px;">
                     <span class="small">AD</span>
                 </div>
             </div>
        </div>

        <!-- Step Nav -->
        <div class="step-nav">
            <div id="navStep1" class="step-item active">
                <div class="step-number">1</div> Upload
            </div>
            <div class="step-connector"></div>
            <div id="navStep2" class="step-item">
                <div class="step-number">2</div> Edit
            </div>
            <div class="step-connector"></div>
             <div id="navStep3" class="step-item">
                <div class="step-number">3</div> Generate
            </div>
            <div class="step-connector"></div>
             <div id="navStep4" class="step-item">
                <div class="step-number">4</div> Finalize
            </div>
        </div>
    </header>

    <main class="container py-4" style="min-height: 80vh;">
        
        <!-- Step 1: Upload -->
        <div id="step1Section" class="row h-100 align-items-center justify-content-center">
            <div class="col-md-8 text-center">
                <div class="mb-5">
                    <h2 class="fw-bold mb-3">Upload Files</h2>
                    <p class="text-secondary">Import your lecture materials to begin the AI generation process.</p>
                </div>

                <div class="row g-4">
                    <div class="col-md-4 text-start">
                        <small class="text-uppercase text-secondary fw-bold" style="letter-spacing: 1px;">Supported Formats</small>
                        <div class="mt-3 d-flex flex-column gap-3">
                             <div class="d-flex align-items-center gap-3 p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                 <i class="bi bi-file-earmark-pdf fs-4 text-danger"></i>
                                 <div>
                                     <div class="small fw-bold">PDF Document</div>
                                     <div class="text-secondary" style="font-size: 0.7rem;">Max 50MB</div>
                                 </div>
                             </div>
                             <div class="d-flex align-items-center gap-3 p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                 <i class="bi bi-file-earmark-ppt fs-4 text-warning"></i>
                                 <div>
                                     <div class="small fw-bold">PowerPoint</div>
                                     <div class="text-secondary" style="font-size: 0.7rem;">.ppt, .pptx</div>
                                 </div>
                             </div>
                        </div>

                        <div class="mt-4 p-3 rounded bg-primary bg-opacity-10 border border-primary border-opacity-25">
                            <div class="d-flex gap-2 text-primary mb-2">
                                <i class="bi bi-stars"></i>
                                <span class="fw-bold small">AI Tips</span>
                            </div>
                            <p class="small text-secondary m-0" style="font-size: 0.8rem;">
                                Ensure your slides have clear headings for better chapter generation.
                            </p>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div id="uploadArea" class="upload-zone h-100 d-flex flex-column align-items-center justify-content-center">
                            <div class="mb-3 bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                <i class="bi bi-cloud-upload fs-3"></i>
                            </div>
                            <h3>Drag & Drop files here</h3>
                            <p class="text-secondary mb-4">or click to browse from your computer</p>
                            
                            <input type="file" id="fileInput" class="d-none" accept=".pdf,.ppt,.pptx">
                            <button id="uploadBtn" class="btn btn-primary px-4 py-2 rounded-pill">
                                <i class="bi bi-plus-lg me-2"></i> Browse Files
                            </button>
                        </div>

                        <div id="fileInfo" class="mt-3 text-center" style="display: none;">
                            <div class="d-inline-flex align-items-center gap-2 bg-card px-3 py-2 rounded border border-secondary">
                                <i class="bi bi-file-earmark-check text-success"></i>
                                <span id="fileName" class="fw-bold">filename.pptx</span>
                                <button onclick="uploadPresentation()" class="btn btn-sm btn-primary ms-3">Upload Now</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Edit -->
        <div id="step2Section" style="display: none;">
            <div class="row g-4 h-100">
                <!-- Left: Preview -->
                <div class="col-lg-7 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                         <h5 class="m-0"><i class="bi bi-easel me-2"></i>Slide Preview</h5>
                         <span class="badge bg-secondary">Slide <span id="currentSlideNum">1</span> / <span id="totalSlides">10</span></span>
                    </div>
                    
                    <div class="slide-preview-container flex-grow-1 bg-black p-4">
                        <!-- Placeholder for slide image or rendered HTML -->
                        <div id="slideVisualContent" class="w-100">
                            <!-- Visual Content Injected Here -->
                        </div>
                    </div>

                    <!-- Thumbnails -->
                    <div class="mt-3">
                         <div id="slidesThumbnailList" class="slide-thumbnails">
                             <!-- Thumbnails injected here -->
                         </div>
                    </div>
                </div>

                <!-- Right: Script Editor -->
                <div class="col-lg-5">
                    <div class="script-editor-container card p-0 h-100">
                        <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center py-3">
                            <h5 class="m-0 text-white"><i class="bi bi-file-text me-2"></i>Script Editor</h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-warning" onclick="generateTextForCurrentSlide()" title="Regenerate with AI">
                                    <i class="bi bi-magic"></i> Gen Text
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="saveCurrentSlideScript()" title="Save Script">
                                    <i class="bi bi-floppy"></i> Save
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 d-flex flex-column">
                            <textarea id="currentScriptEditor" class="script-textarea border-0 w-100 h-100 p-3" style="resize: none; outline: none;" placeholder="Enter narration script for this slide..."></textarea>
                        </div>
                        <div class="card-footer bg-transparent border-top border-secondary p-3 text-end">
                            <button class="btn btn-primary" onclick="goToStep3()">
                                Next: Generate Audio <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Generate -->
        <div id="step3Section" style="display: none;">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-header bg-transparent border-bottom border-secondary py-3">
                            <h5 class="m-0 text-white">Audio Generation Status</h5>
                        </div>
                        <div class="card-body p-3 overflow-auto" style="max-height: 60vh;">
                            <div id="audioGenerationList" class="row g-3">
                                <!-- Audio items injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header bg-transparent border-bottom border-secondary py-3">
                            <h5 class="m-0 text-white">Voice Studio</h5>
                        </div>
                        <div class="card-body">
                            <label class="form-label text-secondary small text-uppercase fw-bold">Select Persona</label>
                            <div class="d-flex flex-column gap-3 mb-4">
                                <!-- VieNeu Option (Default) -->
                                <!-- VieNeu Option (Default) -->
                                <div class="voice-persona-card active" onclick="selectVoice('vieneu')">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                                            <i class="bi bi-music-note-beamed"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-white">VieNeu <span class="badge bg-warning text-dark ms-2" style="font-size: 0.6rem;">PREMIUM</span></div>
                                            <div class="small text-secondary">Giọng đọc AI tự nhiên nhất</div>
                                            <div class="mt-1"><span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.65rem;">Vietnamese</span></div>
                                        </div>
                                        <i class="bi bi-check-circle-fill text-primary ms-auto check-icon" style="display: block;"></i>
                                    </div>
                                    <!-- VieNeu Sub-voices Dropdown -->
                                    <div id="vieneuVoiceSelect" class="mt-2 pt-2 border-top border-secondary" style="display: block;">
                                        <label class="small text-secondary mb-1">Chọn người đọc:</label>
                                        <select id="vieneuVoiceId" class="form-select form-select-sm bg-dark border-secondary text-white">
                                            <option value="Tuyen">Tuyên (Nam - Bắc)</option>
                                            <option value="Ngoc">Ngọc (Nữ - Bắc)</option>
                                            <option value="Ly">Ly (Nữ - Bắc)</option>
                                            <option value="Binh">Bình (Nam - Bắc)</option>
                                            <option value="Vinh">Vĩnh (Nam - Nam)</option>
                                            <option value="Doan">Đoan (Nữ - Nam)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Clone Voice Option -->
                                <div class="voice-persona-card" onclick="selectVoice('clone')">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle bg-danger d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                                            <i class="bi bi-mic"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-white">Clone Voice</div>
                                            <div class="small text-secondary">Sử dụng giọng của bạn</div>
                                            <div class="mt-1"><span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.65rem;">Vietnamese</span></div>
                                        </div>
                                        <i class="bi bi-check-circle-fill text-primary ms-auto check-icon" style="display: none;"></i>
                                    </div>
                                    <!-- Hidden upload input for clone voice -->
                                    <div id="cloneVoiceUpload" class="mt-2 pt-2 border-top border-secondary" style="display: none;">
                                        <label class="small text-secondary mb-1">Upload mẫu giọng (WAV/MP3, 1-3 mins):</label>
                                        <input type="file" id="cloneVoiceInput" class="form-control form-control-sm bg-dark border-secondary text-secondary" accept="audio/*">
                                    </div>
                                </div>

                                <!-- gTTS Option -->
                                <div class="voice-persona-card" onclick="selectVoice('gtts')">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                                            <i class="bi bi-google"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-white">Google TTS <span class="badge bg-success ms-2" style="font-size: 0.6rem;">FREE</span></div>
                                            <div class="small text-secondary">Cơ bản, tốc độ nhanh</div>
                                            <div class="mt-1"><span class="badge bg-info bg-opacity-25 text-info" style="font-size: 0.65rem;">English</span></div>
                                        </div>
                                        <i class="bi bi-check-circle-fill text-primary ms-auto check-icon" style="display: none;"></i>
                                    </div>
                                </div>
                            </div>

                            <button onclick="generateAudioForAll()" class="btn btn-primary w-100 py-2 mb-3">
                                <i class="bi bi-soundwave me-2"></i> Generate All Audio
                            </button>
                            
                            <button onclick="generateVideoForAll()" class="btn btn-outline-primary w-100 py-2 mb-3">
                                <i class="bi bi-film me-2"></i> Generate All Videos
                            </button>
                            
                            <hr class="border-secondary my-4">
                            
                            <button id="step4Btn" onclick="goToStep4()" class="btn btn-success w-100 py-2" style="display: none;">
                                Next: Finalize Video <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Finalize -->
        <div id="step4Section" class="row h-100 align-items-center justify-content-center" style="display: none;">
            <div class="col-lg-8 text-center">
                 <div class="mb-5">
                    <h2 class="fw-bold mb-3">Finalize & Export</h2>
                    <p class="text-secondary">Review your settings and generate the final video presentation.</p>
                </div>

                <div class="card p-4 mb-4 text-start">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="useTalkingHeadCheckbox" onchange="toggleTalkingHeadOption()">
                        <label class="form-check-label fw-bold text-white" for="useTalkingHeadCheckbox">Add AI Talking Head (Virtual MC)</label>
                    </div>
                    
                    <div id="avatarUploadSection" class="ms-5" style="display: none;">
                        <p class="text-secondary small mb-2">Upload a portrait image for the virtual MC (approx 2 mins to generate).</p>
                        
                        <div class="d-flex gap-3 align-items-start">
                             <div id="talkingHeadAvatarPreviewContainer" class="rounded overflow-hidden bg-card border border-secondary d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; border-style: dashed !important;">
                                 <img id="talkingHeadAvatarPreview" src="" class="w-100 h-100 object-fit-cover" style="display: none;">
                                 <i id="talkingHeadAvatarPlaceholder" class="bi bi-person fs-3 text-secondary"></i>
                             </div>
                             <div>
                                 <input type="file" id="talkingHeadAvatarInput" class="form-control bg-dark border-secondary text-secondary mb-2" accept="image/*">
                                 <small class="text-secondary d-block">Supported: JPG, PNG. Optimal ratio 1:1.</small>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center mb-5">
                    <div class="col-md-6">
                        <button onclick="generateFinalVideoV2()" class="btn btn-lg btn-primary w-100 rounded-pill py-3 position-relative overflow-hidden">
                             <span class="position-relative z-1"><i class="bi bi-film me-2"></i> Generate Final Video</span>
                        </button>
                    </div>
                </div>

                <!-- Rendering Status -->
                <div id="generateStatus" class="text-center mb-5">
                    <div id="finalProgressCircle" class="progress-circle mb-3" style="--progress: 0%;">
                         <div id="finalProgressValue" class="progress-value">0%</div>
                    </div>
                    <p class="text-secondary animate-pulse">Rendering video...</p>
                </div>

                <!-- Result -->
                <div id="videoResultContainer" style="display: none;">
                    <div class="card overflow-hidden mb-4 border-primary">
                        <video id="finalVideo" controls class="w-100" style="max-height: 500px; background: black;"></video>
                    </div>
                    <div class="d-flex gap-3 justify-content-center" id="downloadContainer">
                        <a id="downloadVideoBtn" class="btn btn-success px-4 py-2">
                            <i class="bi bi-download me-2"></i> Download Video
                        </a>
                        <button onclick="location.reload()" class="btn btn-outline-secondary px-4 py-2">
                            Create New
                        </button>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 z-3" style="display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h3 class="mt-3 text-white">Processing...</h3>
            <p class="text-muted" id="loadingText">Please wait</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- State Management ---
        let state = {
            presentationId: null,
            slides: [],
            currentSlideIndex: 0,
            voiceSettings: { type: 'preset', voice_id: 'default' } // Global settings
        };

        // --- Constants & Config ---
        const STEPS = {
            UPLOAD: 1,
            EDIT: 2,
            GENERATE: 3,
            FINALIZE: 4
        };

        // --- DOM Elements Cache ---
        const dom = {
            steps: [null, document.getElementById('step1Section'), document.getElementById('step2Section'), document.getElementById('step3Section'), document.getElementById('step4Section')],
            navSteps: [null, document.getElementById('navStep1'), document.getElementById('navStep2'), document.getElementById('navStep3'), document.getElementById('navStep4')],
            fileInput: document.getElementById('fileInput'),
            uploadArea: document.getElementById('uploadArea'),
            fileInfo: document.getElementById('fileInfo'),
            fileName: document.getElementById('fileName'),
            uploadBtn: document.getElementById('uploadBtn'),
            
            // Step 2
            getCurrentSlideNum: () => document.getElementById('currentSlideNum'), // Getter as it might update
            getTotalSlides: () => document.getElementById('totalSlides'),
            scriptEditor: document.getElementById('currentScriptEditor'),
            slideVisual: document.getElementById('slideVisualContent'),
            thumbnailList: document.getElementById('slidesThumbnailList'),
            previewTitle: document.getElementById('previewTitle'),
            previewList: document.getElementById('previewList'),

            // Step 3
            audioList: document.getElementById('audioGenerationList'),
            step4Btn: document.getElementById('step4Btn'),

            // Step 4
            finalProgressCircle: document.getElementById('finalProgressCircle'),
            finalProgressValue: document.getElementById('finalProgressValue'),
            finalVideo: document.getElementById('finalVideo'),
            downloadContainer: document.getElementById('downloadContainer'),
            downloadBtn: document.getElementById('downloadVideoBtn'),
            
            // Overlays
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initUploadHandlers();
            // Check session storage for recovery
            const savedPid = sessionStorage.getItem('presentationId');
            if (savedPid) {
                 // Optionally recover state here (not implemented for simplicity now)
            }
        });

        // --- UI Navigation Handlers ---
        function goToStep(stepNum) {
            // Validate
            if (stepNum > 1 && !state.presentationId) return;

            // Update UI Containers
            dom.steps.forEach((el, idx) => {
                if (el) el.style.display = idx === stepNum ? (stepNum === 1 || stepNum === 4 ? 'flex' : 'block') : 'none'; // Flex for centered steps
                if (el && idx === stepNum && idx === 1) el.className = 'row h-100'; // Reset class for Step 1
                if (el && idx === stepNum && idx === 4) el.className = 'row h-100 align-items-center justify-content-center'; // Reset class for Step 4
            });

            // Update Nav Header
            dom.navSteps.forEach((el, idx) => {
                if (el) {
                    el.classList.remove('active', 'completed');
                    if (idx === stepNum) el.classList.add('active');
                    if (idx < stepNum) el.classList.add('completed');
                }
            });

            // Specific logic per step
            if (stepNum === 2) {
                renderSlide(state.currentSlideIndex);
                renderThumbnails();
            } else if (stepNum === 3) {
                renderAudioList();
            }
        }

        // --- Step 1: Upload Logic ---
        function initUploadHandlers() {
            dom.uploadArea.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', handleFileSelect);

            dom.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dom.uploadArea.classList.add('dragover');
            });

            dom.uploadArea.addEventListener('dragleave', () => dom.uploadArea.classList.remove('dragover'));

            dom.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dom.uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    dom.fileInput.files = e.dataTransfer.files;
                    handleFileSelect({ target: dom.fileInput });
                }
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                dom.fileName.textContent = file.name;
                dom.fileInfo.style.display = 'block';
                // Hide default upload prompt
                dom.uploadArea.querySelector('h3').style.display = 'none';
                dom.uploadArea.querySelector('p').style.display = 'none';
                dom.uploadArea.querySelector('.rounded-circle').style.display = 'none';
                dom.uploadArea.querySelector('.btn-primary').style.display = 'none';
            }
        }

        function clearFile() {
             dom.fileInput.value = '';
             dom.fileInfo.style.display = 'none';
             // Restore default upload prompt
             dom.uploadArea.querySelector('h3').style.display = 'block';
             dom.uploadArea.querySelector('p').style.display = 'block';
             dom.uploadArea.querySelector('.rounded-circle').style.display = 'flex';
             dom.uploadArea.querySelector('.btn-primary').style.display = 'flex';
        }

        async function uploadPresentation() {
            const file = dom.fileInput.files[0];
            if (!file) return;

            showLoading('Uploading & Analyzing Slide Deck...');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/upload-presentation', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.success) {
                    state.presentationId = data.presentation_id;
                    state.slides = data.slides || [];
                    
                    // Normalize slide data structure if needed
                    state.slides = state.slides.map(s => ({
                        ...s,
                        script: s.edited_text || s.generated_text || '', // Use script logic
                        audioUrl: null,
                        videoUrl: null
                    }));

                    goToStep(2);
                } else {
                    alert('Upload failed: ' + data.error);
                }
            } catch (err) {
                console.error(err);
                alert('Upload failed: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // --- Step 2: Edit Logic ---
        function renderThumbnails() {
            dom.thumbnailList.innerHTML = '';
            state.slides.forEach((slide, idx) => {
                const el = document.createElement('div');
                el.className = `slide-thumbnail ${idx === state.currentSlideIndex ? 'active' : ''}`;
                el.textContent = idx + 1;
                el.onclick = () => {
                    saveCurrentScriptState(); // Save before switch
                    state.currentSlideIndex = idx;
                    renderSlide(idx);
                    renderThumbnails(); // Re-render to update active class
                };
                dom.thumbnailList.appendChild(el);
            });
        }

        function renderSlide(idx) {
            const slide = state.slides[idx];
            if (!slide) return;

            // Update Header Info
            dom.getCurrentSlideNum().textContent = idx + 1;
            dom.getTotalSlides().textContent = state.slides.length;

            // Update Script Editor
            dom.scriptEditor.value = slide.script || '';
            dom.scriptEditor.onblur = saveCurrentScriptState; // Auto-save local state on blur

            // Update Visual Preview (Basic Parsing mostly)
            let contentHtml = `
                <h2 class="text-primary mb-4" id="previewTitle">Slide ${slide.slide_num}</h2>
                <div class="text-start text-white" style="font-size: 1.25rem; line-height: 1.6; opacity: 1;">
                    ${slide.content ? slide.content.replace(/\n/g, '<br>') : 'No Text Content'}
                </div>
            `;
            dom.slideVisual.innerHTML = contentHtml;
        }

        function saveCurrentScriptState() {
            if (state.slides[state.currentSlideIndex]) {
                state.slides[state.currentSlideIndex].script = dom.scriptEditor.value;
            }
        }

        async function generateTextForCurrentSlide() {
            const slide = state.slides[state.currentSlideIndex];
            if (!slide) return;

            showLoading('Generating AI Script...');
            try {
                const res = await fetch('/api/generate-text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        presentation_id: state.presentationId,
                        slide_num: slide.slide_num, // Backend uses 1-based index usually
                        language: 'vi'
                    })
                });
                const data = await res.json();
                if (data.success) {
                    dom.scriptEditor.value = data.text;
                    state.slides[state.currentSlideIndex].script = data.text;
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Connection Error');
            } finally {
                hideLoading();
            }
        }

        async function saveCurrentSlideScript() {
            saveCurrentScriptState();
            const slide = state.slides[state.currentSlideIndex];
            
            // Optimistic UI update
            const btn = document.querySelector('button[onclick="saveCurrentSlideScript()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Saving...';
            
            try {
                 const res = await fetch('/api/save-text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        presentation_id: state.presentationId,
                        slide_num: slide.slide_num,
                        edited_text: slide.script
                    })
                });
                const data = await res.json();
                if(data.success) {
                    // alert('Saved!');
                }
            } catch(e) {
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
            }
        }
        
        async function goToStep3() {
            // Save all current scripts first? For now assuming user saves or we save current
            saveCurrentScriptState();
            // TODO: Bulk save if needed
            goToStep(3);
        }

        // --- Step 3: Audio Logic ---
        function renderAudioList() {
            dom.audioList.innerHTML = '';
            state.slides.forEach((slide, idx) => {
                const div = document.createElement('div');
                div.className = 'col-12';
                div.innerHTML = `
                    <div class="bg-card p-3 rounded border border-secondary d-flex flex-column gap-2">
                        <div class="d-flex align-items-center justify-content-between">
                             <div class="d-flex align-items-center gap-3">
                                <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                    ${idx + 1}
                                </div>
                                <div class="text-white small">Slide ${idx + 1}</div>
                            </div>
                            <div class="d-flex gap-2">
                                <span class="badge bg-${slide.audioUrl ? 'success' : 'secondary'} bg-opacity-25 text-${slide.audioUrl ? 'success' : 'light'}">
                                    Audio: ${slide.audioUrl ? 'Ready' : 'Pending'}
                                </span>
                                <span class="badge bg-${slide.videoUrl ? 'primary' : 'secondary'} bg-opacity-25 text-${slide.videoUrl ? 'primary' : 'light'}">
                                    Video: ${slide.videoUrl ? 'Ready' : 'Pending'}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Audio Player -->
                        <div id="audioStatus-${idx}" class="w-100 mt-2">
                            ${slide.audioUrl 
                                ? `<audio controls src="${slide.audioUrl}" class="w-100" style="height: 32px;"></audio>`
                                : `<div class="progress" style="height: 4px;"><div class="progress-bar bg-secondary" style="width: 0%"></div></div>`
                            }
                        </div>

                        <!-- Video Section -->
                        <div id="videoStatus-${idx}" class="w-100 mt-2 pt-2 border-top border-secondary border-opacity-25">
                            ${slide.videoUrl
                                ? `<video controls src="${slide.videoUrl}" class="w-100 rounded" style="max-height: 150px;"></video>`
                                : slide.audioUrl 
                                    ? `<button class="btn btn-sm btn-outline-primary w-100" onclick="generateVideoForSlide(${idx})">
                                         <i class="bi bi-film"></i> Generate Video
                                       </button>`
                                    : ''
                            }
                        </div>
                    </div>
                `;
                dom.audioList.appendChild(div);
            });
            dom.step4Btn.style.display = 'inline-block'; // Always show for now to allow proceeding
        }

        async function generateVideoForSlide(idx) {
            const btn = event.currentTarget;
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

            try {
                // Determine 1-based slide number for API
                // Currently API uses slide_num which seems to be 1-based based on get_slide implementation usually?
                // Let's check get_slide... it takes slide_num. 
                // presentation_model.get_slide usually expects 0-based index or 1-based?
                // Standard array access is 0-based. Let's assume slide_num is index for now, or check usage.
                // In generate_audio, it uses enumerate(slides) so i is 0-based index.
                // And calls get_audio_file_path(..., i, ...)
                // So let's use index `idx` (0-based) for consistency if backend expects 0-based.
                // presentation.py: get_slide(pres_id, slide_num) -> get_slide(..., slide_num)
                // Let's verify presentation_model.get_slide logic.
                // Usually web apps use 1-based for display, 0-based for logic.
                // Let's try passing `idx` (0-based).
                
                const slideNum = idx; 

                const res = await fetch(`/api/presentation/${state.presentationId}/slide/${slideNum}/generate_slide_video`, {
                     method: 'POST'
                });
                const data = await res.json();
                
                if (data.success) {
                    // Update state
                    if (state.slides[idx]) {
                        state.slides[idx].videoUrl = data.video_url;
                    }
                    renderAudioList();
                } else {
                    alert('Error generating video: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            } catch (err) {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        async function generateVideoForAll() {
            if (!state.slides || state.slides.length === 0) return;
            
            showLoading('Generating Videos for all slides...');
            try {
                let completed = 0;
                for (let i = 0; i < state.slides.length; i++) {
                    const slide = state.slides[i];
                    
                    if (slide.audioUrl) {
                        try {
                            // Update loading text
                            const loadingText = document.getElementById('loadingText');
                            if(loadingText) loadingText.textContent = `Generating Video for Slide ${i+1}/${state.slides.length}...`;
                            
                            const res = await fetch(`/api/presentation/${state.presentationId}/slide/${i}/generate_slide_video`, {
                                method: 'POST'
                            });
                            const data = await res.json();
                            if (data.success && state.slides[i]) {
                                state.slides[i].videoUrl = data.video_url;
                            }
                        } catch (e) {
                            console.error(`Failed to gen video for slide ${i}`, e);
                        }
                    }
                    completed++;
                }
                renderAudioList();
            } finally {
                hideLoading();
            }
        }

        function selectVoice(type) {
            // Update UI selection
            document.querySelectorAll('.voice-persona-card').forEach(el => {
                el.classList.remove('active');
                // Hide all check icons
                const check = el.querySelector('.check-icon');
                if(check) check.style.display = 'none';
            });
            
            // Activate current
            const card = event.currentTarget;
            card.classList.add('active');
            const check = card.querySelector('.check-icon');
            if(check) check.style.display = 'block';

            // Show/Hide Clone Upload
            const uploadDiv = document.getElementById('cloneVoiceUpload');
            if(type === 'clone') {
                if(uploadDiv) uploadDiv.style.display = 'block';
            } else {
                if(uploadDiv) uploadDiv.style.display = 'none';
            }

            // Show/Hide VieNeu Voice Select
            const vieneuSelectDiv = document.getElementById('vieneuVoiceSelect');
            if(type === 'vieneu') {
                if(vieneuSelectDiv) vieneuSelectDiv.style.display = 'block';
            } else {
                if(vieneuSelectDiv) vieneuSelectDiv.style.display = 'none';
            }

            state.voiceSettings.type = type;
        }

        function testVoice() {
            alert("Voice preview feature coming soon!");
        }

        async function generateAudioForAll() {
            showLoading('Generating Audio... (This may take a while)');
            
            try {
                let bodyData = {
                    presentation_id: state.presentationId,
                    voice_type: state.voiceSettings.type
                };

                // Handle VieNeu Voice Selection
                if (state.voiceSettings.type === 'vieneu') {
                    const voiceIdSelect = document.getElementById('vieneuVoiceId');
                    if (voiceIdSelect) {
                        bodyData.voice_id = voiceIdSelect.value;
                    }
                }

                // Handle Clone Voice
                if (state.voiceSettings.type === 'clone') {
                    const cloneInput = document.getElementById('cloneVoiceInput');
                    // For now, simpler implementation: if file exists, we might need FormData
                    // But to keep it consistent with 'generate_audio' endpoint which expects JSON or FormData? 
                    // Let's assume the backend handles basic type for now, or we need to implementation FormData if uploading.
                    if (cloneInput && cloneInput.files.length > 0) {
                        alert("Tính năng upload mẫu giọng Clone đang được phát triển. Sẽ sử dụng giọng Clone mặc định.");
                    }
                }

                // Call batch generation endpoint
                const res = await fetch(`/api/presentation/${state.presentationId}/generate_audio`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(bodyData)
                });
                const data = await res.json();
                
                if (data.success && data.results) {
                   // Update local state
                   data.results.forEach(r => {
                       const slideIdx = r.slide_index; // Backend uses 0-based index
                       if (state.slides[slideIdx] && r.success) {
                           state.slides[slideIdx].audioUrl = r.audio_url;
                       }
                   });
                   renderAudioList();
                   dom.step4Btn.style.display = 'inline-block';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                 alert('Error generating audio: ' + err.message);
            } finally {
                hideLoading();
            }
        }
        
        function playAudio(url) {
            // Simple preview player
            const audio = new Audio(url);
            audio.play();
        }
        
        function goToStep4() {
             goToStep(4);
        }

        // --- Step 4: Finalize Logic ---
        
        // Toggle Talking Head Options
        function toggleTalkingHeadOption() {
            const checkbox = document.getElementById('useTalkingHeadCheckbox');
            const avatarSection = document.getElementById('avatarUploadSection');
            
            if (checkbox && avatarSection) {
                avatarSection.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        // Avatar Preview
        function previewAvatar(input) {
            const preview = document.getElementById('talkingHeadAvatarPreview');
            const placeholder = document.getElementById('talkingHeadAvatarPlaceholder');
            const container = document.getElementById('talkingHeadAvatarPreviewContainer');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if(preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    if(placeholder) placeholder.style.display = 'none';
                    if(container) container.style.border = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                if(preview) {
                    preview.src = "";
                    preview.style.display = 'none';
                }
                if(placeholder) placeholder.style.display = 'block';
                if(container) container.style.border = '1px dashed #4b5563';
            }
        }

        // Generate Final Video (Unified V2)
        async function generateFinalVideoV2() {
            if (!state.presentationId) {
                alert('Presentation ID missing');
                return;
            }

            const useTalkingHead = document.getElementById('useTalkingHeadCheckbox').checked;
            const btn = document.querySelector('button[onclick="generateFinalVideoV2()"]');
            const statusDiv = document.getElementById('generateStatus'); // Legacy status
            const resultContainer = document.getElementById('videoResultContainer');
            
            // UI Updates
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = 'Rendering...';
            }
            if(resultContainer) resultContainer.style.display = 'none';
            
            // Simulate Progress (since backend is sync)
            let progress = 0;
            updateFinalProgress(0);
            const progressInterval = setInterval(() => {
                // Asymptotic progress to 90%
                progress += (90 - progress) / 50;
                updateFinalProgress(Math.round(progress));
            }, 500);

            try {
                const formData = new FormData();
                formData.append('use_talking_head', useTalkingHead);
                
                if (useTalkingHead) {
                    const avatarInput = document.getElementById('talkingHeadAvatarInput');
                    if (avatarInput && avatarInput.files.length > 0) {
                        formData.append('avatar', avatarInput.files[0]);
                    } else if (avatarInput) {
                        alert('Vui lòng chọn ảnh Avatar cho MC ảo!');
                        clearInterval(progressInterval);
                        if(btn) {
                            btn.disabled = false;
                            btn.innerHTML = 'Generate Final Video';
                        }
                        return;
                    }
                }

                const response = await fetch(`/api/presentation/${state.presentationId}/generate_final_video_v2`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                clearInterval(progressInterval);
                updateFinalProgress(100);

                if (data.success) {
                    // Update Video Player
                    const video = document.getElementById('finalVideo');
                    const downloadBtn = document.getElementById('downloadVideoBtn');
                    
                    if(video) {
                        video.src = data.video_url + '?t=' + new Date().getTime();
                        video.load();
                    }
                    
                    if(downloadBtn) {
                        downloadBtn.href = data.video_url;
                        downloadBtn.download = `presentation_${state.presentationId}.mp4`;
                    }
                    
                    if(resultContainer) {
                        resultContainer.style.display = 'block';
                        resultContainer.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    alert('✅ Video created successfully!');
                } else {
                    alert('Lỗi: ' + data.error);
                }

            } catch (error) {
                console.error('Error generating final video:', error);
                alert('Đã xảy ra lỗi khi kết nối server.');
            } finally {
                clearInterval(progressInterval);
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Generate Final Video';
                }
            }
        }
        
        function updateFinalProgress(percent) {
            if(dom.finalProgressCircle) {
                dom.finalProgressCircle.style.setProperty('--progress', `${percent}%`);
            }
            if(dom.finalProgressValue) {
                dom.finalProgressValue.textContent = `${percent}%`;
            }
        }

        // --- Other Missing Functions ---
        
        async function saveAllScriptsAndContinue() {
            if (!state.presentationId) {
                alert('No presentation loaded');
                return;
            }

            const textareas = document.querySelectorAll('.script-textarea');
            if (textareas.length === 0) {
                 goToStep(3);
                 return;
            }
            goToStep(3);
        }

        async function loadSlidesForAudioVideo() {
            // Already handled in Step 3 initialization or similar?
            console.log("Loading slides for audio/video...");
        }

        async function generateSlideVideo(slideNum) {
             console.log("Individual slide generation not yet implemented in new UI flow");
        }

        // --- Helpers ---
        function showLoading(text) {
            if(dom.loadingText) dom.loadingText.textContent = text;
            if(dom.loadingOverlay) dom.loadingOverlay.style.display = 'flex';
        }
        
        function hideLoading() {
            if(dom.loadingOverlay) dom.loadingOverlay.style.display = 'none';
        }

        // Event Listeners for file inputs
        document.addEventListener('DOMContentLoaded', () => {
             const avatarInput = document.getElementById('talkingHeadAvatarInput');
             if(avatarInput) {
                 avatarInput.addEventListener('change', function() { previewAvatar(this); });
             }
        });
    </script>
</body>
</html>