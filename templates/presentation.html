<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Video Thuy·∫øt Tr√¨nh - Step 1: Upload Presentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            padding-top: 2rem; 
            background-color: #f8f9fa; 
        }
        .container { 
            max-width: 1000px; 
        }
        .step-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            background: white;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        .upload-area {
            border: 2px dashed #0d6efd;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #e7f1ff;
            border-color: #0a58ca;
        }
        .upload-area.dragover {
            background: #cfe2ff;
            border-color: #0a58ca;
        }
        .slides-preview {
            margin-top: 2rem;
        }
        .slide-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        .slide-header {
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 0.5rem;
        }
        .slide-content {
            color: #6c757d;
            font-size: 0.9rem;
            max-height: 100px;
            overflow-y: auto;
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container py-5">
    <header class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">T·∫°o Video Thuy·∫øt Tr√¨nh</h1>
        <p class="lead">T·ª± ƒë·ªông t·∫°o video thuy·∫øt tr√¨nh v·ªõi avatar n√≥i chuy·ªán</p>
    </header>

    <!-- Step 1: Upload Presentation -->
    <div class="step-card">
        <div class="step-header">
            <div class="step-number">1</div>
            <h3 class="mb-0">Upload File Presentation</h3>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".pptx,.ppt,.pdf" style="display: none;">
            <div>
                <svg width="64" height="64" fill="currentColor" class="text-primary mb-3" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5h2.767l12-12H.5a.5.5 0 0 1-.5.5v11.5z"/>
                    <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.74.439L8 13.069l-5.26 2.87A.5.5 0 0 1 2 15.5V2z"/>
                </svg>
                <h4>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h4>
                <p class="text-muted">H·ªó tr·ª£: .pptx, .ppt, .pdf</p>
                <p class="text-muted">K√≠ch th∆∞·ªõc t·ªëi ƒëa: 100MB</p>
            </div>
        </div>

        <div id="fileInfo" style="display: none;" class="mt-3">
            <div class="alert alert-info">
                <strong>File ƒë√£ ch·ªçn:</strong> <span id="fileName"></span>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearFile()">X√≥a</button>
            </div>
        </div>

        <div class="text-center mt-3">
            <button id="uploadBtn" class="btn btn-primary btn-lg" disabled onclick="uploadPresentation()">
                üì§ Upload v√† ƒê·ªçc File
            </button>
        </div>
    </div>

    <!-- Slides Preview -->
    <div id="slidesPreview" class="step-card" style="display: none;">
        <div class="step-header">
            <div class="step-number">‚úì</div>
            <h3 class="mb-0">N·ªôi dung ƒë√£ ƒë·ªçc ƒë∆∞·ª£c</h3>
        </div>
        
        <div id="slidesList" class="slides-preview"></div>
        
        <div class="text-center mt-4">
            <button class="btn btn-success btn-lg" onclick="goToStep2()">
                Ti·∫øp t·ª•c ‚Üí B∆∞·ªõc 2: Generate Text
            </button>
        </div>
    </div>

    <!-- Step 2: Generate & Edit Text -->
    <div id="step2Section" class="step-card" style="display: none;">
        <div class="step-header">
            <div class="step-number">2</div>
            <h3 class="mb-0">Generate & Edit Text Thuy·∫øt Tr√¨nh</h3>
        </div>
        
        <div class="alert alert-info">
            <strong>üí° H∆∞·ªõng d·∫´n:</strong> 
            <ul class="mb-0">
                <li>Click "Generate Text" ƒë·ªÉ t·∫°o text thuy·∫øt tr√¨nh t·ª± ƒë·ªông t·ª´ n·ªôi dung slide</li>
                <li>B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a text sau khi generate</li>
                <li>Click "Save" ƒë·ªÉ l∆∞u text ƒë√£ ch·ªânh s·ª≠a</li>
            </ul>
        </div>

        <div id="slidesTextContainer"></div>

        <div class="text-center mt-4">
            <button class="btn btn-primary btn-lg" onclick="goToStep3()">
                Ti·∫øp t·ª•c ‚Üí B∆∞·ªõc 3: Upload Avatar
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h3 class="mt-3">ƒêang x·ª≠ l√Ω...</h3>
        <p class="text-muted" id="loadingText">Vui l√≤ng ƒë·ª£i</p>
    </div>
</div>

<script>
    let currentPresentationId = null;
    let selectedFile = null;

    // File input handling
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');

    // Click to select file
    uploadArea.addEventListener('click', () => fileInput.click());

    // File selected
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
        }
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file && (file.name.endsWith('.pptx') || file.name.endsWith('.ppt') || file.name.endsWith('.pdf'))) {
            selectedFile = file;
            fileInput.files = e.dataTransfer.files;
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
        } else {
            alert('Vui l√≤ng ch·ªçn file .pptx, .ppt ho·∫∑c .pdf');
        }
    });

    function clearFile() {
        selectedFile = null;
        fileInput.value = '';
        fileInfo.style.display = 'none';
        uploadBtn.disabled = true;
    }

    async function uploadPresentation() {
        if (!selectedFile) {
            alert('Vui l√≤ng ch·ªçn file');
            return;
        }

        const formData = new FormData();
        formData.append('file', selectedFile);

        showLoading('ƒêang upload v√† ƒë·ªçc file...');

        try {
            const response = await fetch('/api/upload-presentation', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                currentPresentationId = data.presentation_id;
                displaySlides(data.slides);
                hideLoading();
            } else {
                hideLoading();
                alert('L·ªói: ' + data.error);
            }
        } catch (error) {
            hideLoading();
            console.error('Error:', error);
            alert('L·ªói k·∫øt n·ªëi: ' + error.message);
        }
    }

    function displaySlides(slides) {
        const slidesList = document.getElementById('slidesList');
        slidesList.innerHTML = '';

        slides.forEach(slide => {
            const slideDiv = document.createElement('div');
            slideDiv.className = 'slide-item';
            slideDiv.innerHTML = `
                <div class="slide-header">Slide ${slide.slide_num} / ${slide.total_slides}</div>
                <div class="slide-content">${slide.content || '(Kh√¥ng c√≥ n·ªôi dung)'}</div>
            `;
            slidesList.appendChild(slideDiv);
        });

        document.getElementById('slidesPreview').style.display = 'block';
    }

    function goToStep2() {
        if (currentPresentationId) {
            // L∆∞u presentation ID v√†o sessionStorage
            sessionStorage.setItem('presentationId', currentPresentationId);
            // Hi·ªÉn th·ªã Step 2
            document.getElementById('step2Section').style.display = 'block';
            document.getElementById('step2Section').scrollIntoView({ behavior: 'smooth' });
            // Load slides ƒë·ªÉ generate text
            loadSlidesForStep2();
        }
    }

    async function loadSlidesForStep2() {
        if (!currentPresentationId) return;

        try {
            const response = await fetch(`/api/presentation/${currentPresentationId}/slides`);
            const data = await response.json();
            
            if (data.success) {
                displaySlidesForStep2(data.slides);
            }
        } catch (error) {
            console.error('Error loading slides:', error);
        }
    }

    function displaySlidesForStep2(slides) {
        const slidesContainer = document.getElementById('slidesTextContainer');
        slidesContainer.innerHTML = '';

        slides.forEach(slide => {
            const slideDiv = document.createElement('div');
            slideDiv.className = 'slide-text-item mb-4';
            slideDiv.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Slide ${slide.slide_num} / ${slide.total_slides}</h5>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="generateText(${slide.slide_num})">
                                ‚ú® Generate Text
                            </button>
                            <button class="btn btn-sm btn-success ms-2" onclick="saveText(${slide.slide_num})" style="display:none;" id="saveBtn${slide.slide_num}">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <small class="text-muted">N·ªôi dung slide g·ªëc:</small>
                            <div class="bg-light p-2 rounded" style="max-height: 100px; overflow-y: auto;">
                                ${slide.content || '(Kh√¥ng c√≥ n·ªôi dung)'}
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Text thuy·∫øt tr√¨nh:</label>
                            <textarea 
                                class="form-control" 
                                id="textArea${slide.slide_num}" 
                                rows="5" 
                                placeholder="Click 'Generate Text' ƒë·ªÉ t·∫°o text thuy·∫øt tr√¨nh..."
                                oninput="markAsEdited(${slide.slide_num})"
                            >${slide.edited_text || slide.generated_text || ''}</textarea>
                        </div>
                        <div id="textStatus${slide.slide_num}" class="text-muted small"></div>
                    </div>
                </div>
            `;
            slidesContainer.appendChild(slideDiv);
        });
    }

    async function generateText(slideNum) {
        if (!currentPresentationId) return;

        const textArea = document.getElementById(`textArea${slideNum}`);
        const statusDiv = document.getElementById(`textStatus${slideNum}`);
        const saveBtn = document.getElementById(`saveBtn${slideNum}`);

        statusDiv.innerHTML = '<span class="text-info">‚è≥ ƒêang generate text...</span>';
        textArea.disabled = true;

        try {
            const response = await fetch('/api/generate-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    presentation_id: currentPresentationId,
                    slide_num: slideNum,
                    language: 'vi'
                })
            });

            const data = await response.json();

            if (data.success) {
                textArea.value = data.text;
                statusDiv.innerHTML = '<span class="text-success">‚úÖ Text ƒë√£ ƒë∆∞·ª£c generate!</span>';
                saveBtn.style.display = 'inline-block';
            } else {
                statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
            }
        } catch (error) {
            console.error('Error generating text:', error);
            statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
        } finally {
            textArea.disabled = false;
        }
    }

    function markAsEdited(slideNum) {
        const saveBtn = document.getElementById(`saveBtn${slideNum}`);
        if (saveBtn) {
            saveBtn.style.display = 'inline-block';
        }
    }

    async function saveText(slideNum) {
        if (!currentPresentationId) return;

        const textArea = document.getElementById(`textArea${slideNum}`);
        const statusDiv = document.getElementById(`textStatus${slideNum}`);
        const saveBtn = document.getElementById(`saveBtn${slideNum}`);

        statusDiv.innerHTML = '<span class="text-info">‚è≥ ƒêang l∆∞u...</span>';

        try {
            const response = await fetch('/api/save-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    presentation_id: currentPresentationId,
                    slide_num: slideNum,
                    edited_text: textArea.value
                })
            });

            const data = await response.json();

            if (data.success) {
                statusDiv.innerHTML = '<span class="text-success">‚úÖ ƒê√£ l∆∞u!</span>';
                saveBtn.style.display = 'none';
            } else {
                statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói: ${data.error}</span>`;
            }
        } catch (error) {
            console.error('Error saving text:', error);
            statusDiv.innerHTML = `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</span>`;
        }
    }

    function showLoading(text = 'ƒêang x·ª≠ l√Ω...') {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function goToStep3() {
        if (currentPresentationId) {
            alert('B∆∞·ªõc 3 s·∫Ω ƒë∆∞·ª£c implement ti·∫øp theo. Presentation ID: ' + currentPresentationId);
            // TODO: Implement Step 3
        }
    }
</script>

</body>
</html>

