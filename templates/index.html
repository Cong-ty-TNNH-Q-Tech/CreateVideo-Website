<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SadTalker Demo - VideoTeaching</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 2 rem; background-color: #f8f9fa; }
        .container { max-width: 900px; }
        .preview-box { 
            border: 2px dashed #ddd; 
            border-radius: 8px; 
            min-height: 200px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
            background: #fff;
            position: relative;
        }
        .preview-box img, .preview-box video { 
            max-width: 100%; 
            max-height: 300px; 
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container container-fluid py-5">
    <header class="pb-3 mb-4 border-bottom">
        <h1 class="display-5 fw-bold text-primary">SadTalker Web UI</h1>
        <p class="lead">T·∫°o video n√≥i chuy·ªán t·ª´ ·∫£nh tƒ©nh v√† √¢m thanh.</p>
    </header>

    <form id="uploadForm" enctype="multipart/form-data">
        <div class="row g-4">
            <!-- Source Image -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">1. Ch·ªçn ·∫¢nh khu√¥n m·∫∑t (Source Image)</div>
                    <div class="card-body">
                        <input type="file" class="form-control mb-3" id="source_image" name="source_image" accept="image/*" required>
                        <div class="preview-box" id="imagePreview">
                            <span class="text-muted">Ch∆∞a ch·ªçn ·∫£nh</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Driven Audio -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">2. Ch·ªçn √Çm thanh (Driven Audio)</div>
                    <div class="card-body">
                        <input type="file" class="form-control mb-3" id="driven_audio" name="driven_audio" accept="audio/*" required>
                        <div class="preview-box" id="audioPreview">
                            <span class="text-muted">Ch∆∞a ch·ªçn √¢m thanh</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="use_cpu" name="use_cpu">
            <label class="form-check-label" for="use_cpu">
                S·ª≠ d·ª•ng CPU - ‚ö†Ô∏è S·∫Ω r·∫•t ch·∫≠m!
            </label>
        </div>

        <div class="d-grid gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-lg">üöÄ T·∫°o Video (Generate)</button>
        </div>
    </form>

    <!-- Result Section -->
    <div id="resultSection" class="mt-5" style="display: none;">
        <div class="card border-success">
            <div class="card-header bg-success text-white fw-bold">3. K·∫øt qu·∫£ (Result)</div>
            <div class="card-body text-center">
                <video id="resultVideo" controls class="mw-100 rounded shadow-sm"></video>
                <div class="mt-3">
                    <a id="downloadLink" href="#" class="btn btn-outline-success" download>‚¨áÔ∏è T·∫£i Video v·ªÅ</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h3 class="mt-3">ƒêang x·ª≠ l√Ω... vui l√≤ng ƒë·ª£i</h3>
        <p class="text-muted">Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.</p>
    </div>
</div>

<script>
    const sourceImageInput = document.getElementById('source_image');
    const drivenAudioInput = document.getElementById('driven_audio');
    const imagePreview = document.getElementById('imagePreview');
    const audioPreview = document.getElementById('audioPreview');
    const uploadForm = document.getElementById('uploadForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const resultSection = document.getElementById('resultSection');
    const resultVideo = document.getElementById('resultVideo');
    const downloadLink = document.getElementById('downloadLink');

    // Image Preview
    sourceImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            }
            reader.readAsDataURL(file);
        }
    });

    // Audio Preview
    drivenAudioInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            audioPreview.innerHTML = `<audio controls src="${url}" class="w-100"></audio>`;
        }
    });

    // Form Submit
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        loadingOverlay.style.display = 'flex';
        resultSection.style.display = 'none';

        try {
            const response = await fetch('/generate', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                resultVideo.src = data.video_url;
                downloadLink.href = data.video_url;
                resultSection.style.display = 'block';
            } else {
                alert('C√≥ l·ªói x·∫£y ra: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server: ' + error.message);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    });
</script>

</body>
</html>
